<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¾®é›»ç¶²ç·šä¸Šæ§åˆ¶ç³»çµ± v2.0</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .glass { background: rgba(255,255,255,0.72); backdrop-filter: saturate(120%) blur(8px); }
    .card { border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 6px 24px rgba(0,0,0,0.06); }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; line-height: 18px; }
    .badge-ok { background:#E6F6EE; color:#0B7C49; }
    .badge-warn { background:#FFF4E5; color:#8A5200; }
    .badge-err { background:#FFE8E6; color:#9F1239; }
    .badge-sim { background:#E8ECFF; color:#1D4ED8; }

    input[type="range"] { width: 100%; }
    .section-title { font-size: 0.85rem; color:#374151; font-weight:600; }
    .subtle { font-size:12px; color:#6B7280; }
    .logline { white-space: pre-wrap; }
    
    /* æ–°å¢æ ·å¼ */
    .sidebar { background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); }
    .sidebar-item { transition: all 0.3s ease; }
    .sidebar-item:hover { background: rgba(255,255,255,0.1); }
    .sidebar-item.active { background: #27ae60; }
    .page { display: none; }
    .page.active { display: block; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card-alt { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card-warn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    /* å¹³æ»‘éæ¸¡æ•ˆæœ */
    .status-indicator {
      transition: all 0.3s ease-in-out;
    }

    .status-text {
      transition: color 0.3s ease-in-out, background-color 0.3s ease-in-out;
    }

    .connection-indicator {
      transition: background-color 0.3s ease-in-out;
    }

    .btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(0px);
      transition: all 0.1s ease;
    }



    /* æ•¸æ“šé¡¯ç¤ºå€åŸŸçš„å¹³æ»‘éæ¸¡ */
    .data-display {
      transition: all 0.2s ease-in-out;
    }

    /* ç‹€æ…‹å¡ç‰‡çš„å¹³æ»‘éæ¸¡ */
    .status-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .status-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* é é¢åˆ‡æ›å‹•ç•« */
    .page {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page.active {
      opacity: 1;
      transform: translateY(0);
    }

    /* æ—¥ç³»è³ªæ„Ÿåœ–æ¨™æ¨£å¼ */
    .japanese-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #cbd5e1;
      box-shadow:
        0 4px 12px rgba(148, 163, 184, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -1px 0 rgba(148, 163, 184, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .japanese-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%, rgba(148,163,184,0.1) 100%);
      border-radius: inherit;
      pointer-events: none;
    }

    .japanese-icon:hover {
      transform: translateY(-2px);
      box-shadow:
        0 8px 24px rgba(148, 163, 184, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.9),
        inset 0 -1px 0 rgba(148, 163, 184, 0.3);
      border-color: #94a3b8;
    }

    .japanese-icon.active {
      background: linear-gradient(145deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #60a5fa;
      box-shadow:
        0 4px 12px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -1px 0 rgba(59, 130, 246, 0.2);
    }

    .japanese-icon.active::before {
      background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, transparent 50%, rgba(59,130,246,0.1) 100%);
    }

    /* æ—¥ç³»è³ªæ„Ÿå´é‚Šæ¬„åœ–æ¨™ */
    .japanese-sidebar-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
      border: 1.5px solid #cbd5e1;
      box-shadow:
        0 2px 8px rgba(148, 163, 184, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.7);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .japanese-sidebar-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 60%);
      border-radius: inherit;
    }

    .japanese-sidebar-icon svg {
      position: relative;
      z-index: 1;
      filter: drop-shadow(0 1px 2px rgba(71, 85, 105, 0.2));
    }

    .sidebar-item:hover .japanese-sidebar-icon {
      background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
      border-color: #94a3b8;
      box-shadow:
        0 4px 12px rgba(148, 163, 184, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transform: translateY(-1px);
    }

    .sidebar-item.active .japanese-sidebar-icon {
      background: linear-gradient(145deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #60a5fa;
      box-shadow:
        0 3px 10px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .sidebar-item.active .japanese-sidebar-icon::before {
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(59,130,246,0.1) 100%);
    }

    /* æ—¥ç³»è³ªæ„ŸåŠŸèƒ½åœ–æ¨™ */
    .japanese-feature-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 4px 16px rgba(148, 163, 184, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .japanese-feature-icon.blue {
      background: linear-gradient(145deg, #dbeafe 0%, #bfdbfe 100%);
      border: 2px solid #93c5fd;
    }

    .japanese-feature-icon.green {
      background: linear-gradient(145deg, #dcfce7 0%, #bbf7d0 100%);
      border: 2px solid #86efac;
    }

    .japanese-feature-icon.purple {
      background: linear-gradient(145deg, #e9d5ff 0%, #d8b4fe 100%);
      border: 2px solid #c084fc;
    }

    .japanese-feature-icon.orange {
      background: linear-gradient(145deg, #fed7aa 0%, #fdba74 100%);
      border: 2px solid #fb923c;
    }

    .japanese-feature-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 60%);
      border-radius: inherit;
    }

    .japanese-feature-icon svg {
      position: relative;
      z-index: 1;
      filter: drop-shadow(0 1px 3px rgba(71, 85, 105, 0.15));
    }

    .japanese-feature-icon:hover {
      transform: translateY(-2px);
      box-shadow:
        0 8px 24px rgba(148, 163, 184, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    /* æ—¥ç³»åœ–æ¨™é¡è‰²è®Šé«” */
    .japanese-icon.green {
      background: linear-gradient(145deg, #dcfce7 0%, #bbf7d0 100%);
      border-color: #86efac;
    }

    .japanese-icon.green.active {
      background: linear-gradient(145deg, #bbf7d0 0%, #86efac 100%);
      border-color: #22c55e;
    }

    .japanese-icon.blue {
      background: linear-gradient(145deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #93c5fd;
    }

    .japanese-icon.blue.active {
      background: linear-gradient(145deg, #bfdbfe 0%, #93c5fd 100%);
      border-color: #3b82f6;
    }

    .japanese-icon.purple {
      background: linear-gradient(145deg, #e9d5ff 0%, #d8b4fe 100%);
      border-color: #c084fc;
    }

    .japanese-icon.purple.active {
      background: linear-gradient(145deg, #d8b4fe 0%, #c084fc 100%);
      border-color: #8b5cf6;
    }

    .japanese-icon.orange {
      background: linear-gradient(145deg, #fed7aa 0%, #fdba74 100%);
      border-color: #fb923c;
    }

    .japanese-icon.orange.active {
      background: linear-gradient(145deg, #fdba74 0%, #fb923c 100%);
      border-color: #ea580c;
    }

    /* æµæš¢åŒ–å‹•ç•«æ¨£å¼ */
    .smooth-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .smooth-text {
      transition: all 0.4s ease-in-out;
    }

    .smooth-number {
      transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      font-variant-numeric: tabular-nums;
    }

    .smooth-progress {
      transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .smooth-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .smooth-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .pulse-gentle {
      animation: pulse-gentle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-gentle {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.8;
      }
    }

    .fade-in {
      animation: fade-in 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slide-in 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slide-in {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* æ•¸å­—è®ŠåŒ–å‹•ç•« */
    .number-change {
      animation: number-change 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes number-change {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
        color: #3b82f6;
      }
      100% {
        transform: scale(1);
      }
    }

    /* ç‹€æ…‹è®ŠåŒ–å‹•ç•« */
    .status-change {
      animation: status-change 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes status-change {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* é€²åº¦æ¢å‹•ç•« */
    .progress-bar {
      background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
      background-size: 200% 100%;
      animation: progress-shimmer 2s linear infinite;
    }

    @keyframes progress-shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex">

  <!-- ä¾§è¾¹æ  -->
  <aside class="sidebar w-64 min-h-screen text-white flex flex-col">
    <!-- LogoåŒºåŸŸ -->
    <div class="p-6 border-b border-gray-600">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-emerald-400 text-xl shadow-lg">âš¡</div>
        <div>
          <h1 class="text-lg font-bold">å¾®é›»ç¶²ç³»çµ±</h1>
          <p class="text-xs text-gray-300">Microgrid Control v2.0</p>
        </div>
      </div>
    </div>

    <!-- å¯¼èˆªèœå• -->
    <nav class="flex-1 p-4 space-y-2">
      <div class="sidebar-item active rounded-lg p-3 cursor-pointer" onclick="switchPage('dashboard')">
        <div class="flex items-center gap-3">
          <div class="japanese-sidebar-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="#475569"/>
            </svg>
          </div>
          <span class="text-white">ç³»çµ±ä»‹ç´¹</span>
        </div>
      </div>
      <div class="sidebar-item rounded-lg p-3 cursor-pointer" onclick="switchPage('live')">
        <div class="flex items-center gap-3">
          <div class="japanese-sidebar-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#475569"/>
            </svg>
          </div>
          <span class="text-white">å¯¦æ©Ÿç›£æ§</span>
        </div>
      </div>
      <div class="sidebar-item rounded-lg p-3 cursor-pointer" onclick="switchPage('simulation')">
        <div class="flex items-center gap-3">
          <div class="japanese-sidebar-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" stroke="#475569"/>
            </svg>
          </div>
          <span class="text-white">æ¨¡æ“¬æ¸¬è©¦</span>
        </div>
      </div>
      <div class="sidebar-item rounded-lg p-3 cursor-pointer" onclick="switchPage('settings')">
        <div class="flex items-center gap-3">
          <div class="japanese-sidebar-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke="#475569"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="#475569"/>
            </svg>
          </div>
          <span class="text-white">ç³»çµ±è¨­å®š</span>
        </div>
      </div>
      <div class="sidebar-item rounded-lg p-3 cursor-pointer" onclick="switchPage('logs')">
        <div class="flex items-center gap-3">
          <div class="japanese-sidebar-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke="#475569"/>
            </svg>
          </div>
          <span class="text-white">äº‹ä»¶æ—¥èªŒ</span>
        </div>
      </div>
    </nav>

         <!-- åº•éƒ¨çŠ¶æ€ -->
     <div class="p-4 border-t border-gray-600">
       <div class="text-xs text-gray-400">Ver. 2.0.0</div>
     </div>
  </aside>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <main class="flex-1 flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h2 id="page-title" class="text-xl font-semibold">æ§åˆ¶å°</h2>
          <span id="page-subtitle" class="text-sm text-gray-500">ç³»çµ±æ¦‚è¦½</span>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span id="current-time" class="text-sm text-gray-600 smooth-text font-mono">--:--:--</span>
            <span id="time-status" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600 hidden smooth-transition">çœŸå¯¦</span>
          </div>
        </div>
      </div>
    </header>

    <!-- é¡µé¢å†…å®¹ -->
    <div class="flex-1 p-6 overflow-auto">
      
      <!-- ç³»çµ±ä»‹ç´¹é é¢ -->
      <div id="dashboard" class="page active">
        <!-- Hero Section -->
        <div class="text-center mb-12">
          <div class="japanese-icon w-20 h-20 mb-6 mx-auto active">
            <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" stroke="#3b82f6"/>
            </svg>
          </div>
          <h1 class="text-4xl font-bold text-gray-900 mb-4">æ™ºèƒ½å¾®é›»ç¶²æ§åˆ¶ç³»çµ±</h1>
          <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            å…ˆé€²çš„é›»æºç®¡ç†è§£æ±ºæ–¹æ¡ˆï¼Œæ•´åˆå¸‚é›»èˆ‡å‚™æ´é›»æ± ï¼Œæä¾›ç©©å®šå¯é çš„é›»åŠ›ä¾›æ‡‰
          </p>
        </div>

        <!-- æ ¸å¿ƒåŠŸèƒ½ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <div class="text-center p-6">
            <div class="japanese-feature-icon blue mb-4 mx-auto">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="#1e40af"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">æ™ºèƒ½åˆ‡æ›</h3>
            <p class="text-gray-600">è‡ªå‹•åµæ¸¬å¸‚é›»ç‹€æ…‹ï¼Œæ™ºèƒ½åˆ‡æ›é›»æºä¾›æ‡‰ï¼Œç¢ºä¿ä¾›é›»é€£çºŒæ€§</p>
          </div>
          <div class="text-center p-6">
            <div class="japanese-feature-icon green mb-4 mx-auto">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke="#15803d"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">é›»æ± ä¿è­·</h3>
            <p class="text-gray-600">å¤šå±¤æ¬¡å®‰å…¨æ©Ÿåˆ¶ï¼Œæ™ºèƒ½å……æ”¾é›»ç®¡ç†ï¼Œå»¶é•·é›»æ± ä½¿ç”¨å£½å‘½</p>
          </div>
          <div class="text-center p-6">
            <div class="japanese-feature-icon purple mb-4 mx-auto">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="#7c3aed"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">å³æ™‚ç›£æ§</h3>
            <p class="text-gray-600">å…¨æ–¹ä½ç³»çµ±ç›£æ§ï¼Œå³æ™‚æ•¸æ“šåˆ†æï¼Œæä¾›å®Œæ•´çš„é‹è¡Œç‹€æ…‹</p>
          </div>
        </div>

        <!-- ç³»çµ±ç‰¹è‰² -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-8 mb-12">
          <h2 class="text-2xl font-bold text-center mb-8">ç³»çµ±ç‰¹è‰²</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex items-start space-x-3">
              <div class="japanese-icon w-8 h-8 green flex-shrink-0">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#059669"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold">è‡ªå‹•æ™‚æ®µæ§åˆ¶</h4>
                <p class="text-gray-600 text-sm">å¯è¨­å®šç‰¹å®šæ™‚æ®µè‡ªå‹•åˆ‡æ›è‡³å‚™æ´é›»æ± ï¼Œå„ªåŒ–ç”¨é›»æˆæœ¬</p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <div class="japanese-icon w-8 h-8 blue flex-shrink-0">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke="#1d4ed8"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold">å±éšªé–€æª»ä¿è­·</h4>
                <p class="text-gray-600 text-sm">é›»æ± SOCéä½æ™‚è‡ªå‹•ä¿è­·ï¼Œé˜²æ­¢éåº¦æ”¾é›»æå®³</p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <div class="japanese-icon w-8 h-8 purple flex-shrink-0">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" stroke="#7c3aed"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold">æ¨¡æ“¬æ¸¬è©¦åŠŸèƒ½</h4>
                <p class="text-gray-600 text-sm">å®Œæ•´çš„æ¨¡æ“¬ç’°å¢ƒï¼Œå¯å®‰å…¨æ¸¬è©¦å„ç¨®é‹è¡Œå ´æ™¯</p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <div class="japanese-icon w-8 h-8 orange flex-shrink-0">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="#ea580c"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold">Webä»‹é¢æ§åˆ¶</h4>
                <p class="text-gray-600 text-sm">ç›´è§€çš„ç¶²é ä»‹é¢ï¼Œæ”¯æ´é ç«¯ç›£æ§å’Œæ§åˆ¶</p>
              </div>
            </div>
          </div>
        </div>

        <!-- å¿«é€Ÿé–‹å§‹ -->
        <div class="text-center">
          <h2 class="text-2xl font-bold mb-6">é–‹å§‹ä½¿ç”¨</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
            <button onclick="switchPage('settings')" class="group bg-white border-2 border-gray-200 hover:border-blue-500 rounded-xl p-4 transition-all duration-200 hover:shadow-lg">
              <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">âš™ï¸</div>
              <div class="font-semibold text-sm">é€£æ¥è¨­å‚™</div>
              <div class="text-xs text-gray-500 mt-1">è¨­å®šESP32</div>
            </button>
            <button onclick="switchPage('live')" class="group bg-white border-2 border-gray-200 hover:border-green-500 rounded-xl p-4 transition-all duration-200 hover:shadow-lg">
              <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ”Œ</div>
              <div class="font-semibold text-sm">å¯¦æ©Ÿç›£æ§</div>
              <div class="text-xs text-gray-500 mt-1">å³æ™‚æ•¸æ“š</div>
            </button>
            <button onclick="switchPage('simulation')" class="group bg-white border-2 border-gray-200 hover:border-purple-500 rounded-xl p-4 transition-all duration-200 hover:shadow-lg">
              <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ§ª</div>
              <div class="font-semibold text-sm">æ¨¡æ“¬æ¸¬è©¦</div>
              <div class="text-xs text-gray-500 mt-1">åŠŸèƒ½é©—è­‰</div>
            </button>
            <button onclick="switchPage('logs')" class="group bg-white border-2 border-gray-200 hover:border-orange-500 rounded-xl p-4 transition-all duration-200 hover:shadow-lg">
              <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ğŸ“‹</div>
              <div class="font-semibold text-sm">äº‹ä»¶æ—¥èªŒ</div>
              <div class="text-xs text-gray-500 mt-1">ç³»çµ±è¨˜éŒ„</div>
            </button>
          </div>
        </div>
      </div>

             <!-- å®æœºç›‘æ§é¡µé¢ -->
       <div id="live" class="page">
         <div class="glass card rounded-xl p-6">
           <h3 class="text-lg font-semibold mb-4">å¯¦æ©Ÿç›£æ§</h3>
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                          <!-- æ§åˆ¶æŒ‰é’® -->
             <div>
               <h4 class="font-semibold mb-4">æ‰‹å‹•æ§åˆ¶</h4>
               
               <!-- ä¸»è¦æ§åˆ¶æŒ‰é’® -->
               <div class="grid grid-cols-2 gap-4 mb-4">
                 <button onclick="setManual('grid')" id="btn-grid" class="btn bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:opacity-50 text-white font-medium py-4 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                   <div class="flex flex-col items-center">
                     <span class="text-2xl mb-2">ğŸ”Œ</span>
                     <span class="text-sm font-semibold">åˆ‡æ›ç‚ºå¸‚é›»</span>
                     <span class="text-xs opacity-75 mt-1">Grid Power</span>
                   </div>
                 </button>
                 
                 <button onclick="setManual('backup')" id="btn-backup" class="btn bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium py-4 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                   <div class="flex flex-col items-center">
                     <span class="text-2xl mb-2">ğŸ”‹</span>
                     <span class="text-sm font-semibold">åˆ‡æ›ç‚ºå‚™æ´</span>
                     <span class="text-xs opacity-75 mt-1">Backup Power</span>
                   </div>
                 </button>
               </div>
               
               <!-- è‡ªåŠ¨æ¨¡å¼æŒ‰é’® -->
               <button onclick="setAutoMode()" class="btn w-full bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                 <div class="flex items-center justify-center">
                   <span class="text-lg mr-2">ğŸ”„</span>
                   <span class="font-semibold">å›åˆ°è‡ªå‹•æ¨¡å¼</span>
                 </div>
               </button>
               
               <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
               <div class="mt-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                 <div class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                   <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                   ç•¶å‰ç‹€æ…‹
                 </div>
                 <div class="grid grid-cols-1 gap-3">
                   <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm smooth-card">
                     <div class="flex items-center">
                       <span class="text-lg mr-2">ğŸ”„</span>
                       <span class="text-sm text-gray-600">é‹è¡Œæ¨¡å¼</span>
                     </div>
                     <span id="live-current-mode" class="font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded-md text-sm smooth-text">è‡ªå‹•</span>
                   </div>
                   <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm smooth-card">
                     <div class="flex items-center">
                       <span class="text-lg mr-2">âš¡</span>
                       <span class="text-sm text-gray-600">ä¾›é›»ä¾†æº</span>
                     </div>
                     <span id="live-current-power" class="font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-md text-sm smooth-text">å¸‚é›»</span>
                   </div>
                   <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm smooth-card">
                     <div class="flex items-center">
                       <span class="text-lg mr-2">ğŸ”Œ</span>
                       <span class="text-sm text-gray-600">å¸‚é›»ç‹€æ…‹</span>
                     </div>
                     <span id="live-current-grid" class="font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-md text-sm smooth-text">æ­£å¸¸</span>
                   </div>
                   <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm smooth-card">
                     <div class="flex items-center">
                       <span class="text-lg mr-2">ğŸ›¡ï¸</span>
                       <span class="text-sm text-gray-600">åˆ‡æ›ä¿è­·</span>
                     </div>
                     <span id="live-switch-guard" class="font-semibold text-gray-600 bg-gray-50 px-2 py-1 rounded-md text-sm smooth-text">å°±ç·’</span>
                   </div>
                 </div>
               </div>
             </div>

             <!-- ESP32å®æ—¶æ•°æ® -->
             <div>
               <h4 class="font-semibold mb-3">ESP32 å¯¦æ™‚æ•¸æ“š</h4>
               <div class="grid grid-cols-2 gap-4">
                 <!-- SOCå¡ç‰‡ -->
                 <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white smooth-card">
                   <div class="flex items-center justify-between mb-2">
                     <span class="text-sm opacity-90">SOC</span>
                     <span class="text-xs opacity-75">é›»æ± é›»é‡</span>
                   </div>
                   <div id="live-soc" class="text-2xl font-bold mb-2 smooth-number font-mono">-- %</div>
                   <div class="w-full bg-blue-200 bg-opacity-30 h-3 rounded-full border border-blue-300 border-opacity-50">
                     <div id="live-soc-bar" class="h-3 rounded-full bg-white smooth-progress shadow-sm" style="width:0%"></div>
                   </div>
                 </div>

                 <!-- ç”µå‹å¡ç‰‡ -->
                 <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white smooth-card">
                   <div class="flex items-center justify-between mb-2">
                     <span class="text-sm opacity-90">é›»å£“</span>
                     <span class="text-xs opacity-75">é›»æ± é›»å£“</span>
                   </div>
                   <div id="live-vbatt" class="text-2xl font-bold smooth-number font-mono">-- V</div>
                   <div class="text-xs opacity-75 mt-1">12V ç³»çµ±</div>
                 </div>

                 <!-- ç”µæµå¡ç‰‡ -->
                 <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-4 text-white smooth-card">
                   <div class="flex items-center justify-between mb-2">
                     <span class="text-sm opacity-90">é›»æµ</span>
                     <span class="text-xs opacity-75">é›»æ± é›»æµ</span>
                   </div>
                   <div id="live-ibatt" class="text-2xl font-bold smooth-number font-mono">-- A</div>
                   <div id="live-current-status" class="text-xs opacity-75 mt-1 smooth-text">å¾…æ©Ÿä¸­</div>
                 </div>

                 <!-- æ„Ÿæµ‹å™¨çŠ¶æ€å¡ç‰‡ -->
                 <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white smooth-card">
                   <div class="flex items-center justify-between mb-2">
                     <span class="text-sm opacity-90">æ„Ÿæ¸¬å™¨</span>
                     <span class="text-xs opacity-75">ç³»çµ±ç‹€æ…‹</span>
                   </div>
                   <div id="live-sensor" class="text-2xl font-bold smooth-text">--</div>
                   <div class="text-xs opacity-75 mt-1">ç›£æ§ä¸­</div>
                 </div>
               </div>

               <!-- è¿æ¥çŠ¶æ€å’Œæ—¶é—´ -->
               <div class="mt-4 grid grid-cols-2 gap-4">
                 <div class="bg-gray-50 rounded-lg p-3">
                   <div class="flex items-center gap-2">
                     <div id="live-connection-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                     <span class="text-sm text-gray-600">é€£æ¥ç‹€æ…‹</span>
                   </div>
                   <div id="live-connection-text" class="text-sm font-semibold text-gray-800 mt-1">æœªé€£æ¥</div>
                 </div>
                 <div class="bg-gray-50 rounded-lg p-3">
                   <div class="text-sm text-gray-600">æœ€å¾Œæ›´æ–°</div>
                   <div id="live-last-update" class="text-sm font-semibold text-gray-800 mt-1">--</div>
                 </div>
               </div>
             </div>
           </div>
         </div>
       </div>

      <!-- æ¨¡æ‹Ÿæµ‹è¯•é¡µé¢ -->
      <div id="simulation" class="page">
        <div class="glass card rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">æ¨¡æ“¬æ¸¬è©¦</h3>
          <!-- æ¨¡æ‹Ÿç›‘æ§å’Œæ‰‹åŠ¨æ§åˆ¶é¢æ¿ -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            
            <!-- å·¦ä¾§ï¼šæ‰‹åŠ¨æ§åˆ¶ -->
            <div>
              <h4 class="font-semibold mb-3">æ‰‹å‹•æ§åˆ¶</h4>
              
              <!-- æ¨¡æ‹Ÿå¼€å…³ -->
              <div class="mb-4">
                <h5 class="font-semibold mb-2 text-gray-700">æ¨¡æ“¬é–‹é—œ</h5>
                <button onclick="toggleSim()" id="sim-toggle-btn" class="btn w-full bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-medium py-2 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                  <div class="flex items-center justify-center">
                    <span class="text-base mr-2">ğŸ§ª</span>
                    <span class="text-sm font-semibold">é–‹å•Ÿæ¨¡æ“¬æ¨¡å¼</span>
                  </div>
                </button>
                <div class="text-xs text-gray-600 mt-2">
                  <p>â€¢ æ¨¡æ“¬é›»æºç‹€æ…‹è®ŠåŒ–</p>
                  <p>â€¢ æ¸¬è©¦ç³»çµ±è‡ªå‹•åˆ‡æ›</p>
                  <p>â€¢ é©—è­‰å®‰å…¨ä¿è­·æ©Ÿåˆ¶</p>
                </div>
              </div>
              
              <!-- ä¸»è¦æ§åˆ¶æŒ‰é’® -->
              <div class="grid grid-cols-1 gap-3 mb-4">
                <button onclick="setManual('grid')" id="sim-btn-grid" class="btn bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:opacity-50 text-white font-medium py-3 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                  <div class="flex flex-col items-center">
                    <span class="text-xl mb-1">ğŸ”Œ</span>
                    <span class="text-sm font-semibold">åˆ‡æ›ç‚ºå¸‚é›»</span>
                    <span class="text-xs opacity-75">Grid Power</span>
                  </div>
                </button>
                
                <button onclick="setManual('backup')" id="sim-btn-backup" class="btn bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 disabled:opacity-50 text-white font-medium py-3 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                  <div class="flex flex-col items-center">
                    <span class="text-xl mb-1">ğŸ”‹</span>
                    <span class="text-sm font-semibold">åˆ‡æ›ç‚ºå‚™æ´</span>
                    <span class="text-xs opacity-75">Backup Power</span>
                  </div>
                </button>
              </div>
              
              <!-- è‡ªåŠ¨æ¨¡å¼æŒ‰é’® -->
              <button onclick="setAutoMode()" class="btn w-full bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-medium py-2 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 mb-3">
                <div class="flex items-center justify-center">
                  <span class="text-base mr-2">ğŸ”„</span>
                  <span class="text-sm font-semibold">å›åˆ°è‡ªå‹•æ¨¡å¼</span>
                </div>
              </button>

              <!-- å¸‚é›»ç‹€æ…‹æ§åˆ¶ -->
              <button onclick="toggleGridPower()" class="btn w-full bg-gradient-to-br from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium py-2 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 mb-3">
                <div class="flex items-center justify-center">
                  <span class="text-base mr-2">âš¡</span>
                  <span class="text-sm font-semibold">åˆ‡æ›å¸‚é›»ç‹€æ…‹</span>
                </div>
              </button>
              <div class="text-xs text-gray-600">
                <p>â€¢ æ¨¡æ“¬å¸‚é›»ä¸­æ–·/æ¢å¾©</p>
                <p>â€¢ æ¸¬è©¦è‡ªå‹•åˆ‡æ›é‚è¼¯</p>
                <p>â€¢ æœƒè§¸ç™¼ESP32å¯¦éš›åˆ‡æ›</p>
              </div>
            </div>

            <!-- å³ä¾§ï¼šæ¨¡æ‹Ÿç›‘æ§ -->
            <div class="lg:col-span-2">
              <h4 class="font-semibold mb-3">æ¨¡æ“¬ç›£æ§</h4>
              
              <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
              <div class="mb-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                <div class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                  <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                  ç•¶å‰ç‹€æ…‹
                </div>
                <div class="grid grid-cols-1 gap-3">
                  <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm status-card">
                    <div class="flex items-center">
                      <span class="text-lg mr-2">ğŸ”„</span>
                      <span class="text-sm text-gray-600">é‹è¡Œæ¨¡å¼</span>
                    </div>
                    <span id="sim-current-mode" class="font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded-md text-sm status-text smooth-text">è‡ªå‹•</span>
                  </div>
                  <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm status-card">
                    <div class="flex items-center">
                      <span class="text-lg mr-2">âš¡</span>
                      <span class="text-sm text-gray-600">ä¾›é›»ä¾†æº</span>
                    </div>
                    <span id="sim-current-power" class="font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-md text-sm status-text smooth-text">å¸‚é›»</span>
                  </div>
                  <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm status-card">
                    <div class="flex items-center">
                      <span class="text-lg mr-2">ğŸ”Œ</span>
                      <span class="text-sm text-gray-600">å¸‚é›»ç‹€æ…‹</span>
                    </div>
                    <span id="sim-current-grid" class="font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-md text-sm status-text smooth-text">æ­£å¸¸</span>
                  </div>
                </div>
              </div>

              <!-- æ¨¡æ‹Ÿæ•°æ®å¡ç‰‡ -->
              <div class="grid grid-cols-2 gap-4">
                <!-- SOCå¡ç‰‡ -->
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white smooth-card">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm opacity-90">SOC</span>
                    <span class="text-xs opacity-75">é›»æ± é›»é‡</span>
                  </div>
                  <div id="sim-soc-display" class="text-2xl font-bold mb-2 data-display smooth-number font-mono">-- %</div>
                  <div class="w-full bg-blue-200 bg-opacity-30 h-3 rounded-full border border-blue-300 border-opacity-50">
                    <div id="sim-soc-bar" class="h-3 rounded-full bg-white smooth-progress shadow-sm" style="width:0%"></div>
                  </div>
                </div>

                <!-- ç”µå‹å¡ç‰‡ -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white smooth-card">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm opacity-90">é›»å£“</span>
                    <span class="text-xs opacity-75">é›»æ± é›»å£“</span>
                  </div>
                  <div id="sim-vbatt-display" class="text-2xl font-bold data-display smooth-number font-mono">-- V</div>
                  <div class="text-xs opacity-75 mt-1">12V ç³»çµ±</div>
                </div>

                <!-- ç”µæµå¡ç‰‡ -->
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-4 text-white smooth-card">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm opacity-90">é›»æµ</span>
                    <span class="text-xs opacity-75">é›»æ± é›»æµ</span>
                  </div>
                  <div id="sim-ibatt-display" class="text-2xl font-bold data-display smooth-number font-mono">-- A</div>
                  <div id="sim-current-status" class="text-xs opacity-75 mt-1 smooth-text">å¾…æ©Ÿä¸­</div>
                </div>

                <!-- æ„Ÿæµ‹å™¨çŠ¶æ€å¡ç‰‡ -->
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white smooth-card">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm opacity-90">æ„Ÿæ¸¬å™¨</span>
                    <span class="text-xs opacity-75">ç³»çµ±ç‹€æ…‹</span>
                  </div>
                  <div id="sim-sensor-display" class="text-2xl font-bold data-display smooth-text">æ¨¡æ“¬</div>
                  <div class="text-xs opacity-75 mt-1">æ¨¡æ“¬ä¸­</div>
                </div>
              </div>


            </div>
          </div>

          <!-- æ¨¡æ‹Ÿè®¾ç½®é¢æ¿ -->
          <div id="sim-settings-panel" class="glass card rounded-xl p-6">
            <h4 class="font-semibold mb-4">æ¨¡æ“¬ç‹€æ…‹è¨­å®š</h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- æ¨¡æ‹Ÿæ—¶é—´ -->
              <div>
                <h5 class="font-semibold mb-3">æ¨¡æ“¬æ™‚é–“è¨­å®š</h5>
                <div class="space-y-3">
                  <div class="flex gap-2">
                    <input type="time" id="mock-time" class="bg-gray-50 border-2 border-gray-400 text-gray-900 px-3 py-2 rounded-lg flex-1 focus:border-blue-500 focus:bg-white transition-colors">
                    <input type="number" id="mock-sec" min="0" max="59" class="bg-gray-50 border-2 border-gray-400 text-gray-900 px-3 py-2 rounded-lg w-20 focus:border-blue-500 focus:bg-white transition-colors" placeholder="ç§’">
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <button onclick="applyMockTime()" class="btn bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium py-2 px-4 rounded-lg shadow-lg">
                      <div class="flex items-center justify-center">
                        <div class="icon-container w-5 h-5 mr-2 bg-gradient-to-br from-white/20 to-white/10 rounded-md flex items-center justify-center border border-white/40">
                          <svg class="icon-svg w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#ffffff"/>
                          </svg>
                        </div>
                        <span>å¥—ç”¨æ™‚é–“</span>
                      </div>
                    </button>
                    <button onclick="resetMockTime()" class="btn bg-gradient-to-br from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white font-medium py-2 px-4 rounded-lg shadow-lg">
                      <div class="flex items-center justify-center">
                        <div class="icon-container w-5 h-5 mr-2 bg-gradient-to-br from-white/20 to-white/10 rounded-md flex items-center justify-center border border-white/40">
                          <svg class="icon-svg w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke="#ffffff"/>
                          </svg>
                        </div>
                        <span>é‡ç½®æ™‚é–“</span>
                      </div>
                    </button>
                  </div>
                  <div class="text-xs text-gray-700 mt-2 bg-gray-50 p-2 rounded-md">
                    <p>â€¢ <span class="font-semibold text-blue-700">å¥—ç”¨æ™‚é–“</span>ï¼šè¨­å®šæ¨¡æ“¬æ™‚é–“ä¸¦é–‹å§‹è‡ªå‹•æ¨é€²</p>
                    <p>â€¢ <span class="font-semibold text-gray-700">é‡ç½®æ™‚é–“</span>ï¼šå›åˆ°çœŸå¯¦æ™‚é–“</p>
                  </div>
                </div>
              </div>

              <!-- æ¨¡æ‹Ÿæ§åˆ¶ï¼ˆåƒ…ç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼é¡¯ç¤ºï¼‰ -->
              <div id="sim-controls" style="display: none;">
                <h5 class="font-semibold mb-3">æ¨¡æ“¬æ§åˆ¶</h5>
                <div class="space-y-3">
                  <div>
                    <label class="text-sm text-gray-600">SOC æ§åˆ¶</label>
                    <div class="flex items-center gap-2 mt-1">
                      <input id="sim-soc" type="range" min="0" max="100" step="0.1" value="78" class="flex-1" />
                      <span id="sim-soc-val" class="text-sm font-semibold w-16">--%</span>
                    </div>
                  </div>
                  <div>
                    <label class="text-sm text-gray-600">é›»æµæ§åˆ¶</label>
                    <div class="flex items-center gap-2 mt-1">
                      <input id="sim-i" type="range" min="-10" max="10" step="0.1" value="0" class="flex-1" />
                      <span id="sim-i-val" class="text-sm font-semibold w-20">-- A</span>
                    </div>
                  </div>
                  <button onclick="simReset()" class="btn bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg w-full">ğŸ”„ é‡è¨­æ¨¡æ“¬åƒæ•¸</button>
                </div>
              </div>
            </div>
            
            <!-- æ¨¡æ“¬æ¨¡å¼é¸é … -->
            <div class="mt-6 pt-4 border-t border-gray-200">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h5 class="font-semibold text-gray-700">æ¨¡æ“¬æ¨¡å¼é¸é …</h5>
                  <p class="text-sm text-gray-600">é¸æ“‡æ¨¡æ“¬æ•¸æ“šçš„ä¾†æº</p>
                </div>
                <div class="flex items-center gap-3">
                  <label class="flex items-center gap-2">
                    <input type="radio" name="sim-mode" value="esp32" checked class="text-blue-600">
                    <span class="text-sm">ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="radio" name="sim-mode" value="local" class="text-blue-600">
                    <span class="text-sm">ç´”æœ¬åœ°æ¨¡æ“¬</span>
                  </label>
                </div>
              </div>

            </div>
          </div>

          <!-- æ¨¡æ“¬æ¸¬è©¦èªªæ˜ -->
          <div class="glass card rounded-xl p-6 mt-6">
            <div id="sim-description" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center">
                <span class="text-blue-600 text-lg mr-2">â„¹ï¸</span>
                <div>
                  <h4 class="font-semibold text-blue-800">æ¨¡æ“¬æ¸¬è©¦èªªæ˜</h4>
                  <p id="sim-description-text" class="text-sm text-blue-700 mt-1">
                    æ¨¡æ“¬é›»æºç‹€æ…‹è®ŠåŒ–ï¼Œæ¸¬è©¦ç³»çµ±åæ‡‰ï¼š
                  </p>
                  <ul id="sim-description-list" class="text-sm text-blue-700 mt-2 ml-4 list-disc">
                    <li>æ¨¡æ“¬å¸‚é›»ä¸­æ–·/æ¢å¾©</li>
                    <li>æ¸¬è©¦è‡ªå‹•åˆ‡æ›é‚è¼¯</li>
                    <li>é©—è­‰ç³»çµ±å®‰å…¨æ©Ÿåˆ¶</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ç³»ç»Ÿè®¾å®šé¡µé¢ -->
      <div id="settings" class="page">
        <div class="glass card rounded-xl p-6 max-w-md mx-auto">
          <h3 class="text-lg font-semibold mb-4">ESP32 é€£æ¥è¨­å®š</h3>

          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 block mb-2">ESP32 ä½å€</label>
              <input id="cfg-ip" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="http://192.168.0.104" />
              <p class="text-xs text-gray-500 mt-1">è¼¸å…¥ESP32çš„å®Œæ•´ç¶²å€</p>
            </div>

            <div class="flex gap-2">
              <button class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex-1" onclick="connectESP()">é€£æ¥</button>
              <button class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg" onclick="testConnection()">æ¸¬è©¦</button>
            </div>

            <div id="connection-status" class="text-sm text-center py-2 rounded-lg bg-gray-100">
              <span class="text-gray-600">å°šæœªé€£æ¥</span>
            </div>

            <div class="text-xs text-gray-500 mt-3 p-3 bg-blue-50 rounded-lg">
              <p class="font-medium text-blue-800 mb-1">é€£æ¥å¾Œå¯ä½¿ç”¨ï¼š</p>
              <p>â€¢ å¯¦æ©Ÿç›£æ§ - æŸ¥çœ‹çœŸå¯¦ç¡¬é«”æ•¸æ“š</p>
              <p>â€¢ ESP32æ¨¡æ“¬ - ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ç¡¬é«”</p>
            </div>
          </div>
        </div>
      </div>

      <!-- äº‹ä»¶æ—¥å¿—é¡µé¢ -->
      <div id="logs" class="page">
        <div class="glass card rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">äº‹ä»¶æ—¥èªŒ</h3>
          <div class="flex justify-between items-center mb-4">
            <div>
              <span class="text-sm text-gray-600">å³æ™‚äº‹ä»¶ä¸²æµ</span>
              <span id="event-count" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded">0 äº‹ä»¶</span>
            </div>
            <div class="flex gap-2">
              <select id="event-filter" class="text-xs border border-gray-300 rounded px-2 py-1" onchange="filterEvents()">
                <option value="all">å…¨éƒ¨äº‹ä»¶</option>
                <option value="error">éŒ¯èª¤</option>
                <option value="system">ç³»çµ±</option>
                <option value="switch">åˆ‡æ›</option>
                <option value="sim">æ¨¡æ“¬</option>
              </select>
              <button class="text-sm underline text-gray-600" onclick="clearBacklog()">æ¸…ç©ºæ—¥èªŒ</button>
            </div>
          </div>
          <div id="backlog" class="bg-white border border-gray-200 rounded-lg p-4 h-96 overflow-y-auto text-sm"></div>
        </div>
      </div>

    </div>
  </main>

  <script>
    // ===== å°å·¥å…· =====
    const $ = (id) => document.getElementById(id);
    const fmt = (d) => new Date(d).toLocaleTimeString();
    const MAIN_MSG_MIN_MS = 3000; // ä¸»è¨Šæ¯ç¯€æµ
    let lastMainMsgAt = 0, lastMainMsgText = '';
    function setMainMsg(msg, force=false){
      const now = Date.now();
      if (force || (msg !== lastMainMsgText && (now - lastMainMsgAt) >= MAIN_MSG_MIN_MS)) {
        lastMainMsgAt = now; lastMainMsgText = msg;
      }
    }
    const backEvents = [];
    function pushBack(type, msg){
      const t = Date.now();
      backEvents.push({t, type, msg});
      if (backEvents.length > 200) backEvents.shift();

      // å¦‚æœç•¶å‰åœ¨äº‹ä»¶æ—¥èªŒé é¢ï¼Œä½¿ç”¨éæ¿¾æ¸²æŸ“
      if (currentPage === 'logs') {
        filterEvents();
      } else {
        renderBacklog();
      }
    }
    function renderBacklog(){
      const box = $('backlog');
      if (!box) return;

      const getEventStyle = (type) => {
        switch(type) {
          case 'error': return 'text-red-600 bg-red-50 border-l-4 border-red-500';
          case 'system': return 'text-blue-600 bg-blue-50 border-l-4 border-blue-500';
          case 'switch': return 'text-green-600 bg-green-50 border-l-4 border-green-500';
          case 'sim': return 'text-purple-600 bg-purple-50 border-l-4 border-purple-500';
          case 'warning': return 'text-yellow-600 bg-yellow-50 border-l-4 border-yellow-500';
          default: return 'text-gray-600 bg-gray-50 border-l-4 border-gray-300';
        }
      };

      const getEventIcon = (type) => {
        switch(type) {
          case 'error': return 'âŒ';
          case 'system': return 'ğŸ”§';
          case 'switch': return 'ğŸ”„';
          case 'sim': return 'ğŸ§ª';
          case 'warning': return 'âš ï¸';
          default: return 'â„¹ï¸';
        }
      };

      box.innerHTML = backEvents.map(e =>
        `<div class="logline mb-2 p-2 rounded ${getEventStyle(e.type)}">
          <span class="font-mono text-xs text-gray-500">[${fmt(e.t)}]</span>
          <span class="ml-2">${getEventIcon(e.type)} ${e.type.toUpperCase()}</span>
          <div class="mt-1 ml-4">${e.msg}</div>
        </div>`
      ).join('');
      box.scrollTop = box.scrollHeight;
    }
    function clearBacklog(){
      backEvents.length = 0;
      renderBacklog();
      pushBack('system', 'äº‹ä»¶æ—¥èªŒå·²æ¸…ç©º');
    }

    function filterEvents() {
      const filterElement = $('event-filter');
      const boxElement = $('backlog');
      
      if (!filterElement || !boxElement) {
        console.warn('äº‹ä»¶éæ¿¾å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      const filter = filterElement.value || 'all';
      const filteredEvents = filter === 'all' ? backEvents : backEvents.filter(e => e.type === filter);

      const getEventStyle = (type) => {
        switch(type) {
          case 'error': return 'text-red-600 bg-red-50 border-l-4 border-red-500';
          case 'system': return 'text-blue-600 bg-blue-50 border-l-4 border-blue-500';
          case 'switch': return 'text-green-600 bg-green-50 border-l-4 border-green-500';
          case 'sim': return 'text-purple-600 bg-purple-50 border-l-4 border-purple-500';
          case 'warning': return 'text-yellow-600 bg-yellow-50 border-l-4 border-yellow-500';
          default: return 'text-gray-600 bg-gray-50 border-l-4 border-gray-300';
        }
      };

      const getEventIcon = (type) => {
        switch(type) {
          case 'error': return 'âŒ';
          case 'system': return 'ğŸ”§';
          case 'switch': return 'ğŸ”„';
          case 'sim': return 'ğŸ§ª';
          case 'warning': return 'âš ï¸';
          default: return 'â„¹ï¸';
        }
      };

      boxElement.innerHTML = filteredEvents.map(e =>
        `<div class="logline mb-2 p-2 rounded ${getEventStyle(e.type)}">
          <span class="font-mono text-xs text-gray-500">[${fmt(e.t)}]</span>
          <span class="ml-2">${getEventIcon(e.type)} ${e.type.toUpperCase()}</span>
          <div class="mt-1 ml-4">${e.msg}</div>
        </div>`
      ).join('');
      boxElement.scrollTop = boxElement.scrollHeight;

      // æ›´æ–°äº‹ä»¶è¨ˆæ•¸
      updateEventCount();
    }

    function updateEventCount() {
      const countEl = $('event-count');
      if (countEl) {
        const filter = $('event-filter')?.value || 'all';
        const count = filter === 'all' ? backEvents.length : backEvents.filter(e => e.type === filter).length;
        countEl.textContent = `${count} äº‹ä»¶`;

        // å¦‚æœæœ‰éŒ¯èª¤äº‹ä»¶ï¼Œé«˜äº®é¡¯ç¤º
        const errorCount = backEvents.filter(e => e.type === 'error').length;
        if (errorCount > 0) {
          countEl.className = 'ml-2 text-xs bg-red-200 text-red-800 px-2 py-1 rounded font-medium';
          countEl.textContent = `${count} äº‹ä»¶ (${errorCount} éŒ¯èª¤)`;
        } else {
          countEl.className = 'ml-2 text-xs bg-gray-200 px-2 py-1 rounded';
        }
      }
    }

    // ===== åˆ†é›¢ç‹€æ…‹ç®¡ç† =====
    // å¯¦æ©Ÿç‹€æ…‹
    let mode = 'auto';
    let supply = 'grid';    // 'grid' or 'backup'
    let gridPower = true;   // å¸‚é›»å¯ç”¨å¦
    let userChoice = 'grid'; // è¨˜éŒ„ç”¨æˆ¶åŸæœ¬çš„é¸æ“‡
    let mockNow = null;
    let espIP = "http://192.168.0.104";
    let currentPage = 'dashboard'; // å½“å‰é¡µé¢
    let esp32Connected = false; // ESP32é€£æ¥ç‹€æ…‹
    
    // æ¨¡æ“¬ç‹€æ…‹ï¼ˆç¨ç«‹ï¼‰
    let simMode = 'auto';
    let simSupply = 'grid';    // 'grid' or 'backup'
    let simGridPower = true;   // æ¨¡æ“¬å¸‚é›»å¯ç”¨å¦
    let simUserChoice = 'grid'; // è¨˜éŒ„ç”¨æˆ¶åŸæœ¬çš„é¸æ“‡

    // åˆ‡æ›ä¿è­·
    let guardUntilTs = 0;         // ä¿è­·çµæŸæ™‚é–“æˆ³
    let pendingSwitch = null;     // {target, reason}
    function canSwitch(){ return Date.now() >= guardUntilTs; }
    function performSwitch(target, reason){
      supply = target;
      sendCommand(target);
      updateDisplay();
      guardUntilTs = Date.now() + SETTINGS.sys.switchGuardSec*1000;
      pendingSwitch = null;
      pushBack('switch', `${reason||'switch'} â†’ ${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
    }
    function requestSwitch(target, reason, opts={}){
      const bypass = opts.bypass === true;
      if (bypass || canSwitch()){
        performSwitch(target, reason);
        setMainMsg(`å·²åˆ‡æ›ç‚º${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
      } else {
        pendingSwitch = {target, reason};
        const remain = Math.ceil((guardUntilTs - Date.now())/1000);
        pushBack('guard', `ä¿è­·å»¶æ™‚ä¸­ï¼Œå·²æ’ç¨‹åˆ‡æ›ç‚º${target==='grid'?'å¸‚é›»':'å‚™æ´'}ï¼ˆç´„ ${remain}s å¾Œï¼‰`);
        setMainMsg(`ä¿è­·å»¶æ™‚ä¸­ï¼Œ${remain}s å¾Œåˆ‡æ›ç‚º${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
      }
    }
    function checkPendingSwitch(){
      if (pendingSwitch && canSwitch()){
        performSwitch(pendingSwitch.target, pendingSwitch.reason||'queued');
        setMainMsg(`å·²åˆ‡æ›ç‚º${pendingSwitch.target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
      }
    }

    // ===== è¨­å®š =====
    const LSKEY = 'microgrid_ui_settings_v105';
    const SETTINGS = {
      net: { espIP, pollBaseMs: 1000, pollFastMs: 500, boostHoldMs: 5000 },
      calib: { vGain: 1.0, vOffset: 0.0, iGain: 1.0, iOffset: 0.0 },
      sim: {
        Rint: 0.08,
        socThreshold: 40,   // ä¸€èˆ¬é–€æª»
        critThreshold: 20,  // å±éšªé–€æª»ï¼ˆè§¸ç™¼å……é›»é–ï¼‰
        stopSoc: 95,        // åœå…… SOC
        Ichg: 1.0, Idis: -1.5,
        dSocChg: 0.15, dSocDis: -0.20, // % per sec
        noiseV: 0.02, ocvOffset: 0.0, ocvGain: 1.0,
        critRetryMs: 5000
      },
      sys: { switchGuardSec: 3 }   // åˆ‡æ›ä¿è­·ç§’æ•¸
    };
    function saveSettings(){ localStorage.setItem(LSKEY, JSON.stringify(SETTINGS)); }
    function loadSettings(){
      const s = localStorage.getItem(LSKEY); if (!s) return;
      try { const o = JSON.parse(s);
        Object.assign(SETTINGS.net, o.net||{});
        Object.assign(SETTINGS.calib, o.calib||{});
        Object.assign(SETTINGS.sim, o.sim||{});
        Object.assign(SETTINGS.sys, o.sys||{});
        espIP = SETTINGS.net.espIP || espIP;
      } catch(e){
        console.warn('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', e);
        pushBack('warning', 'è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
      }
    }
    function resetSettings(){ localStorage.removeItem(LSKEY); location.reload(); }

    // ===== æ™‚æ®µè¦å‰‡ï¼š12:30â€“12:59 å‚™æ´ï¼›13:00 å›å¸‚é›» =====
    function isBackupWindow(now){
      const h = now.getHours(), m = now.getMinutes();
      return (h === 12 && m >= 30); // 12:30~12:59
    }
    function isJustOutWindow(now){
      const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
      return (h === 13 && m === 0 && s < 5); // 13:00:00 - 13:00:04 (5ç§’ç·©è¡)
    }

    // ===== UI è¡Œç‚º =====
    function setManual(target) {
      if (currentPage === 'simulation') {
        // æª¢æŸ¥æ¨¡æ“¬æ¨¡å¼æ˜¯å¦å·²é–‹å•Ÿ
        if (typeof SIM === 'undefined' || !SIM.enabled) {
          pushBack('sim', 'âš ï¸ è«‹å…ˆé–‹å•Ÿæ¨¡æ“¬æ¨¡å¼');
          return;
        }

        // å±éšªé–æª¢æŸ¥ï¼šé›»æ± ä¿è­·æ¨¡å¼ä¸­ç¦æ­¢æ‰‹å‹•åˆ‡æ›
        if (SIM.critLock) {
          pushBack('sim', `ğŸ”’ é›»æ± ä¿è­·æ¨¡å¼ï¼šSOCéä½ï¼Œç³»çµ±å·²é–å®šå……é›»æ¨¡å¼ï¼Œè«‹ç­‰å¾…å……é›»è‡³ ${SETTINGS.sim.stopSoc}% å¾Œé‡è©¦`);
          return;
        }

        // æ“ä½œæ¨¡æ“¬ç‹€æ…‹
        if (target === 'grid' && !simGridPower) {
          pushBack('sim', 'âš ï¸ æ¨¡æ“¬å¸‚é›»ä¸­æ–·ï¼Œç„¡æ³•åˆ‡æ›ç‚ºå¸‚é›»');
          return;
        }

        // å±éšªé–€æª»ä¿è­·ï¼šSOCéä½æ™‚ä¸å…è¨±åˆ‡æ›åˆ°å‚™æ´
        if (target === 'backup' && typeof SIM !== 'undefined' && SIM.soc <= SETTINGS.sim.critThreshold && simGridPower) {
          pushBack('sim', `âš ï¸ å®‰å…¨ä¿è­·ï¼šSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼Œä¸å…è¨±æ‰‹å‹•åˆ‡æ›åˆ°å‚™æ´ï¼Œè«‹å…ˆå……é›»è‡³ ${SETTINGS.sim.stopSoc}%`);
          return;
        }

        simMode = 'manual';
        simSupply = target;
        simUserChoice = target; // è¨˜éŒ„ç”¨æˆ¶é¸æ“‡
        pushBack('sim', `æ¨¡æ“¬æ‰‹å‹•åˆ‡æ›ç‚º${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);

        // ç«‹å³æ›´æ–°é¡¯ç¤ºï¼ˆé¿å…èˆ‡ç´”æœ¬åœ°æ¨¡æ“¬å®šæ™‚å™¨è¡çªï¼‰
        if (getSimMode() !== 'local') {
          updateSimDisplay();
        }

        // å¦‚æœæ˜¯ESP32æ¨¡å¼ï¼Œç™¼é€ç‹€æ…‹åˆ°ESP32
        if (getSimMode() === 'esp32') {
          sendPowerSimulationState();
        }
      } else {
        // æ“ä½œå¯¦æ©Ÿç‹€æ…‹

        // æª¢æŸ¥ESP32é€£æ¥ç‹€æ…‹
        if (!esp32Connected) {
          setMainMsg('âš ï¸ ESP32æœªé€£æ¥ï¼Œç„¡æ³•é€²è¡Œå¯¦æ©Ÿåˆ‡æ›', true);
          pushBack('error', 'ESP32æœªé€£æ¥ï¼Œè«‹å…ˆåœ¨ç³»çµ±è¨­å®šä¸­é€£æ¥ESP32');
          return;
        }

        // å¯¦æ©Ÿå±éšªé–æª¢æŸ¥ï¼šé›»æ± ä¿è­·æ¨¡å¼ä¸­ç¦æ­¢æ‰‹å‹•åˆ‡æ›
        if (realCritLock) {
          setMainMsg(`ğŸ”’ å¯¦æ©Ÿé›»æ± ä¿è­·æ¨¡å¼ï¼šSOCéä½ï¼Œç³»çµ±å·²é–å®šå……é›»æ¨¡å¼ï¼Œè«‹ç­‰å¾…å……é›»è‡³ ${SETTINGS.sim.stopSoc}% å¾Œé‡è©¦`, true);
          pushBack('error', `ğŸ”’ å¯¦æ©Ÿé›»æ± ä¿è­·æ¨¡å¼ï¼šSOCéä½ï¼Œç³»çµ±å·²é–å®šå……é›»æ¨¡å¼ï¼Œè«‹ç­‰å¾…å……é›»è‡³ ${SETTINGS.sim.stopSoc}% å¾Œé‡è©¦`);
          return;
        }

        // æª¢æŸ¥å¸‚é›»ç‹€æ…‹
        if (target === 'grid' && !gridPower) {
          setMainMsg('âš ï¸ å¸‚é›»ä¸­æ–·ï¼Œç„¡æ³•åˆ‡æ›ç‚ºå¸‚é›»', true);
          pushBack('error', 'å¸‚é›»ä¸­æ–·ï¼Œç„¡æ³•åˆ‡æ›ç‚ºå¸‚é›»');
          return;
        }

        // å¯¦æ©Ÿå±éšªé–€æª»ä¿è­·ï¼šSOCéä½æ™‚ä¸å…è¨±åˆ‡æ›åˆ°å‚™æ´
        if (target === 'backup' && lastRealSOC !== null && lastRealSOC <= SETTINGS.sim.critThreshold && gridPower) {
          setMainMsg(`âš ï¸ å¯¦æ©Ÿå®‰å…¨ä¿è­·ï¼šSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼Œä¸å…è¨±æ‰‹å‹•åˆ‡æ›åˆ°å‚™æ´ï¼Œè«‹å…ˆå……é›»è‡³ ${SETTINGS.sim.stopSoc}%`, true);
          pushBack('error', `âš ï¸ å¯¦æ©Ÿå®‰å…¨ä¿è­·ï¼šSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼Œä¸å…è¨±æ‰‹å‹•åˆ‡æ›åˆ°å‚™æ´ï¼Œè«‹å…ˆå……é›»è‡³ ${SETTINGS.sim.stopSoc}%`);
          return;
        }

        // æª¢æŸ¥åˆ‡æ›ä¿è­·
        if (!canSwitch()) {
          const remainingTime = Math.ceil((guardUntilTs - Date.now()) / 1000);
          setMainMsg(`âš ï¸ åˆ‡æ›ä¿è­·ä¸­ï¼Œè«‹ç­‰å¾… ${remainingTime} ç§’`, true);
          pushBack('error', `åˆ‡æ›ä¿è­·ä¸­ï¼Œé‚„éœ€ç­‰å¾… ${remainingTime} ç§’`);
          return;
        }

        mode = 'manual';
        userChoice = target; // è¨˜éŒ„ç”¨æˆ¶é¸æ“‡
        pushBack('switch', `å¯¦æ©Ÿæ‰‹å‹•åˆ‡æ›è«‹æ±‚ï¼š${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
        requestSwitch(target, 'manual');
      }
    }

    function setAutoMode() {
      if (currentPage === 'simulation') {
        // æª¢æŸ¥æ¨¡æ“¬æ¨¡å¼æ˜¯å¦å·²é–‹å•Ÿ
        if (typeof SIM === 'undefined' || !SIM.enabled) {
          pushBack('sim', 'âš ï¸ è«‹å…ˆé–‹å•Ÿæ¨¡æ“¬æ¨¡å¼');
          return;
        }

        simMode = 'auto';
        pushBack('sim', 'æ¨¡æ“¬å·²åˆ‡æ›ç‚ºè‡ªå‹•æ¨¡å¼');
        evaluateSimAutoMode();

        // ç«‹å³æ›´æ–°é¡¯ç¤ºï¼ˆé¿å…èˆ‡ç´”æœ¬åœ°æ¨¡æ“¬å®šæ™‚å™¨è¡çªï¼‰
        if (getSimMode() !== 'local') {
          updateSimDisplay();
        }
      } else {
        mode = 'auto';
        setMainMsg('å·²åˆ‡æ›ç‚ºè‡ªå‹•æ¨¡å¼', true);
        evaluateAutoMode(false);
      }
    }
    
    function toggleGridPower() {
      if (currentPage === 'simulation') {
        // æª¢æŸ¥æ¨¡æ“¬æ¨¡å¼æ˜¯å¦å·²é–‹å•Ÿ
        if (typeof SIM === 'undefined' || !SIM.enabled) {
          pushBack('sim', 'âš ï¸ è«‹å…ˆé–‹å•Ÿæ¨¡æ“¬æ¨¡å¼');
          return;
        }

        // æ“ä½œæ¨¡æ“¬ç‹€æ…‹
        const wasGridPower = simGridPower;
        simGridPower = !simGridPower;
        
        if (!simGridPower && simSupply==='grid'){
          // æ¨¡æ“¬å¸‚é›»ç¬æ–·çš„è™•ç†
          if (SIM.critLock) {
            // å……é›»ä¿è­·æœŸé–“ï¼šä¸åˆ‡æ›åˆ°å‚™æ´ï¼Œåœæ­¢ä¾›é›»ç­‰å¾…å¸‚é›»æ¢å¾©
            // simSupply ä¿æŒ 'grid'ï¼Œä½†å¯¦éš›ä¸Šç„¡æ³•ä¾›é›»
            const now = getNow();
            const inBackupWindow = isBackupWindow(now);
            const currentTime = now.toTimeString().split(' ')[0];
            const timeContext = inBackupWindow ? `ï¼ˆå‚™æ´æ™‚æ®µ ${currentTime}ï¼‰` : `ï¼ˆ${currentTime}ï¼‰`;

            pushBack('sim', `ğŸ”’ å¸‚é›»ä¸­æ–·${timeContext}ï¼šé›»æ± ä¿è­·æ¨¡å¼ä¸­ï¼Œåœæ­¢ä¾›é›»ç­‰å¾…å¸‚é›»æ¢å¾©ï¼ˆç¦æ­¢æ”¾é›»ä¿è­·é›»æ± ï¼‰`);
          } else {
            // æ­£å¸¸æƒ…æ³ï¼šç«‹å³åˆ‡å‚™æ´ï¼ˆå®‰å…¨è€ƒæ…®ï¼‰
            simSupply = 'backup';
            pushBack('sim', 'æ¨¡æ“¬å¸‚é›»ä¸­æ–·ï¼Œè‡ªå‹•åˆ‡æ›ç‚ºå‚™æ´');
          }
        } else if (simGridPower && !wasGridPower){
          // æ¨¡æ“¬å¸‚é›»æ¢å¾© â†’ å„ªå…ˆè™•ç†å±éšªé–æƒ…æ³
          if (SIM.critLock) {
            // å±éšªé–ç‹€æ…‹ï¼šç«‹å³åˆ‡å›å¸‚é›»ç¹¼çºŒå……é›»
            simSupply = 'grid';
            pushBack('sim', 'ğŸ”‹ å¸‚é›»æ¢å¾©ï¼šé›»æ± ä¿è­·æ¨¡å¼ä¸­ï¼Œç«‹å³åˆ‡å›å¸‚é›»ç¹¼çºŒå……é›»');
          } else if (simMode === 'auto') {
            evaluateSimAutoMode();
          } else if (simMode === 'manual' && simUserChoice === 'grid') {
            // æ‰‹å‹•æ¨¡å¼ä¸‹ï¼Œå¦‚æœç”¨æˆ¶åŸæœ¬é¸æ“‡å¸‚é›»ï¼Œå¸‚é›»æ¢å¾©æ™‚åˆ‡å›å¸‚é›»
            simSupply = 'grid';
            pushBack('sim', 'æ¨¡æ“¬å¸‚é›»æ¢å¾©ï¼Œåˆ‡å›ç”¨æˆ¶åŸæœ¬é¸æ“‡çš„å¸‚é›»');
          }
        }
        
        pushBack('sim', `æ¨¡æ“¬å¸‚é›»ç‹€æ…‹æ”¹ç‚ºï¼š${simGridPower?'æ­£å¸¸':'ä¸­æ–·'}`);

        // ç«‹å³æ›´æ–°é¡¯ç¤ºï¼ˆé¿å…èˆ‡ç´”æœ¬åœ°æ¨¡æ“¬å®šæ™‚å™¨è¡çªï¼‰
        if (getSimMode() !== 'local') {
          updateSimDisplay();
        }

        // å¦‚æœæ˜¯ESP32æ¨¡å¼ï¼Œç™¼é€ç‹€æ…‹åˆ°ESP32
        if (typeof SIM !== 'undefined' && SIM.enabled && getSimMode() === 'esp32') {
          sendPowerSimulationState();
        }
        
        // ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32
        if (typeof SIM !== 'undefined' && SIM.enabled) {
          sendSimulationState();
        }
      } else {
        // æ“ä½œå¯¦æ©Ÿç‹€æ…‹
        const wasGridPower = gridPower;
        gridPower = !gridPower;
        
        if (!gridPower && supply==='grid'){
          // å¸‚é›»ç¬æ–· â†’ ç«‹å³åˆ‡å‚™æ´ï¼ˆå®‰å…¨è€ƒæ…®ï¼‰
          requestSwitch('backup', 'grid_lost', {bypass:true});
        } else if (gridPower && !wasGridPower){
          // å¸‚é›»æ¢å¾© â†’ æ ¹æ“šç”¨æˆ¶åŸæœ¬çš„é¸æ“‡æ±ºå®šæ˜¯å¦åˆ‡å›
          if (mode === 'auto') {
            evaluateAutoMode(false);
          } else if (mode === 'manual' && userChoice === 'grid') {
            // æ‰‹å‹•æ¨¡å¼ä¸‹ï¼Œå¦‚æœç”¨æˆ¶åŸæœ¬é¸æ“‡å¸‚é›»ï¼Œå¸‚é›»æ¢å¾©æ™‚åˆ‡å›å¸‚é›»
            requestSwitch('grid', 'user_choice_restore');
          }
        }
        
        pushBack('grid', `å¸‚é›»ç‹€æ…‹æ”¹ç‚ºï¼š${gridPower?'æ­£å¸¸':'ä¸­æ–·'}`);
        setMainMsg(`å¸‚é›»${gridPower?'æ¢å¾©':'ä¸­æ–·'}`, true);
      }
    }
    function applyMockTime() {
      const timeInputElement = $('mock-time');
      const secInputElement = $('mock-sec');
      
      if (!timeInputElement) {
        pushBack('error', 'æ™‚é–“è¼¸å…¥å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      const timeInput = timeInputElement.value.trim();
      const sec = secInputElement ? parseInt(secInputElement.value || '0') : 0;
      
      if (!timeInput) {
        pushBack('error', 'è«‹è¼¸å…¥æœ‰æ•ˆæ™‚é–“');
        return;
      }

      try {
        const [hour, minute] = timeInput.split(':').map(Number);
        if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
          pushBack('error', 'æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ HH:MM æ ¼å¼');
          return;
        }
        
        const now = new Date();
        now.setHours(hour, minute, sec, 0);
        mockNow = now;

        updateDisplay();
        updateTime(); // ç«‹å³æ›´æ–°é ‚éƒ¨æ™‚é–“é¡¯ç¤º

        // ç«‹å³è§¸ç™¼è‡ªå‹•è©•ä¼°ï¼Œæª¢æŸ¥æ–°æ™‚é–“æ˜¯å¦éœ€è¦åˆ‡æ›
        if (typeof SIM !== 'undefined' && SIM.enabled) {
          evaluateSimAutoMode(false); // ä¸æ¨é€²æ™‚é–“ï¼Œåªè©•ä¼°ç•¶å‰æ™‚é–“
        }

        // å¦‚æœæ˜¯ESP32æ¨¡å¼ï¼Œç«‹å³ç™¼é€æ–°çš„æ™‚é–“ç‹€æ…‹
        if (typeof SIM !== 'undefined' && SIM.enabled && getSimMode() === 'esp32') {
          sendPowerSimulationState();
        }

        pushBack('sim', `â±ï¸ æ¨¡æ“¬æ™‚é–“å·²è¨­å®šç‚ºï¼š${mockNow.toLocaleTimeString()}`);
      } catch (e) {
        pushBack('error', `æ™‚é–“è¨­å®šå¤±æ•—ï¼š${e.message}`);
      }
    }

    function resetMockTime() {
      try {
        mockNow = null; // é‡ç½®ç‚ºçœŸå¯¦æ™‚é–“

        updateDisplay();
        updateTime(); // ç«‹å³æ›´æ–°é ‚éƒ¨æ™‚é–“é¡¯ç¤º

        // æ¸…ç©ºæ™‚é–“è¼¸å…¥æ¡†
        const timeInputElement = $('mock-time');
        const secInputElement = $('mock-sec');
        if (timeInputElement) timeInputElement.value = '';
        if (secInputElement) secInputElement.value = '';

        // ç«‹å³è§¸ç™¼è‡ªå‹•è©•ä¼°ï¼Œä½¿ç”¨çœŸå¯¦æ™‚é–“é‡æ–°è©•ä¼°
        if (SIM.enabled) {
          evaluateSimAutoMode(false); // ä¸æ¨é€²æ™‚é–“ï¼Œåªè©•ä¼°ç•¶å‰æ™‚é–“
        }

        // å¦‚æœæ˜¯ESP32æ¨¡å¼ï¼Œç«‹å³ç™¼é€é‡ç½®å¾Œçš„æ™‚é–“ç‹€æ…‹
        if (SIM.enabled && getSimMode() === 'esp32') {
          sendPowerSimulationState();
        }

        pushBack('sim', `ğŸ”„ å·²é‡ç½®ç‚ºçœŸå¯¦æ™‚é–“ï¼š${new Date().toLocaleTimeString()}`);
      } catch (e) {
        pushBack('error', `æ™‚é–“é‡ç½®å¤±æ•—ï¼š${e.message}`);
      }
    }


    function getNow(){ return mockNow ? mockNow : new Date(); }
    function updateDisplay(){
      const now = getNow(); const timeStr = now.toTimeString().split(' ')[0];
      const isLocalSim = (typeof SIM !== 'undefined' && SIM.enabled && getSimMode() === 'local');

      // ç³»çµ±ä»‹ç´¹é é¢ä¸éœ€è¦ç‹€æ…‹é¡¯ç¤ºï¼Œè·³éé€™äº›å…ƒç´ çš„æ›´æ–°
      
      // æ›´æ–°å¯¦æ©Ÿç›£æ§é é¢çš„ç•¶å‰ç‹€æ…‹é¡¯ç¤ºï¼ˆåªé¡¯ç¤ºå¯¦æ©Ÿç‹€æ…‹ï¼Œä¸å—æ¨¡æ“¬å½±éŸ¿ï¼‰
      const liveCurrentMode = $('live-current-mode');
      const liveCurrentPower = $('live-current-power');
      const liveCurrentGrid = $('live-current-grid');

      if (liveCurrentMode) {
        // å¯¦æ©Ÿç›£æ§é é¢åªé¡¯ç¤ºå¯¦æ©Ÿæ¨¡å¼ï¼Œä¸å—æ¨¡æ“¬æ¨¡å¼å½±éŸ¿
        liveCurrentMode.textContent = mode === 'manual' ? 'æ‰‹å‹•' : 'è‡ªå‹•';
        liveCurrentMode.className = `font-semibold px-2 py-1 rounded-md text-sm ${mode === 'manual' ? 'text-orange-600 bg-orange-50' : 'text-blue-600 bg-blue-50'}`;
      }

      if (liveCurrentPower) {
        // å¯¦æ©Ÿç›£æ§é é¢åªé¡¯ç¤ºå¯¦æ©Ÿä¾›é›»ç‹€æ…‹
        liveCurrentPower.textContent = supply === 'grid' ? 'å¸‚é›»' : 'å‚™æ´';
        liveCurrentPower.className = `font-semibold px-2 py-1 rounded-md text-sm ${supply === 'grid' ? 'text-blue-600 bg-blue-50' : 'text-green-600 bg-green-50'}`;
      }

      if (liveCurrentGrid) {
        // å¯¦æ©Ÿç›£æ§é é¢åªé¡¯ç¤ºå¯¦æ©Ÿå¸‚é›»ç‹€æ…‹
        liveCurrentGrid.textContent = gridPower ? 'æ­£å¸¸' : 'ä¸­æ–·';
        liveCurrentGrid.className = `font-semibold px-2 py-1 rounded-md text-sm ${gridPower ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}`;
      }

      // æ›´æ–°åˆ‡æ›ä¿è­·ç‹€æ…‹
      const liveSwitchGuard = $('live-switch-guard');
      if (liveSwitchGuard) {
        const now = Date.now();
        const canSwitchNow = canSwitch();

        // æª¢æŸ¥æ˜¯å¦æœ‰é›»æ± ä¿è­·ç‹€æ…‹éœ€è¦é¡¯ç¤º
        if (realCritLock) {
          liveSwitchGuard.textContent = 'é›»æ± ä¿è­·ä¸­';
          liveSwitchGuard.className = 'font-semibold text-red-600 bg-red-50 px-2 py-1 rounded-md text-sm';
        } else if (canSwitchNow) {
          liveSwitchGuard.textContent = 'å°±ç·’';
          liveSwitchGuard.className = 'font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-md text-sm';
        } else {
          const remainingTime = Math.ceil((guardUntilTs - now) / 1000);
          liveSwitchGuard.textContent = `ä¿è­·ä¸­ (${remainingTime}s)`;
          liveSwitchGuard.className = 'font-semibold text-yellow-600 bg-yellow-50 px-2 py-1 rounded-md text-sm';
        }
      }

      // æ›´æ–°å¯¦æ©Ÿæ¨¡å¼æŒ‰éˆ•ç‹€æ…‹ï¼ˆè€ƒæ…®é›»æ± ä¿è­·ç‹€æ…‹ï¼‰
      const btnGrid = $('btn-grid');
      const btnBackup = $('btn-backup');

      if (btnGrid) {
        const gridDisabled = !gridPower || !esp32Connected || !canSwitch() || realCritLock;
        btnGrid.disabled = gridDisabled;
        btnGrid.classList.toggle('opacity-50', gridDisabled);
      }

      if (btnBackup) {
        // å‚™æ´æŒ‰éˆ•é¡å¤–æª¢æŸ¥å±éšªé–€æª»ä¿è­·
        const isDangerousSOC = lastRealSOC !== null && lastRealSOC <= SETTINGS.sim.critThreshold && gridPower;
        const backupDisabled = !esp32Connected || !canSwitch() || realCritLock || isDangerousSOC;
        btnBackup.disabled = backupDisabled;
        btnBackup.classList.toggle('opacity-50', backupDisabled);
      }

      // æ›´æ–°æ¨¡æ“¬æ¨¡å¼æŒ‰éˆ•ç‹€æ…‹
      const simBtnGrid = $('sim-btn-grid');
      if (simBtnGrid) {
        simBtnGrid.disabled = !simGridPower;
        simBtnGrid.classList.toggle('opacity-50', !simGridPower);
      }
      
      const simBtnBackup = $('sim-btn-backup');
      if (simBtnBackup) {
        // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ SIM å°è±¡å·²å®šç¾©
        const isDangerousSOC = (typeof SIM !== 'undefined' && SIM.soc <= 25);
        simBtnBackup.disabled = isDangerousSOC;
        simBtnBackup.classList.toggle('opacity-50', isDangerousSOC);
      }
    }
    // ç™¼é€å®Œæ•´æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32ï¼ˆç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼ä½¿ç”¨ï¼‰
    function sendSimulationState() {
      if (!SIM.enabled) return;

      // æ ¹æ“šESP32æ•¸æ“šæ ¼å¼ç™¼é€å®Œæ•´æ¨¡æ“¬ç‹€æ…‹
      const currentTime = getNow(); // ä½¿ç”¨æ­£ç¢ºçš„æ™‚é–“ï¼ˆæ¨¡æ“¬æ™‚é–“æˆ–çœŸå¯¦æ™‚é–“ï¼‰
      const simState = {
        grid_power: simGridPower,
        mode: simMode,
        supply: simSupply,
        soc: SIM.soc,
        battery_voltage: ocvFromSoc(SIM.soc),
        battery_current: SIM.currentA,
        timestamp: currentTime.getTime(),
        current_hour: currentTime.getHours(),
        current_minute: currentTime.getMinutes(),
        is_mock_time: mockNow !== null
      };

      fetch(`${espIP}/simulation`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(simState)
      }).then(() => {
        pushBack('sim', `å®Œæ•´æ¨¡æ“¬ç‹€æ…‹å·²ç™¼é€åˆ°ESP32ï¼šå¸‚é›»${simGridPower?'æ­£å¸¸':'ä¸­æ–·'}, SOC:${SIM.soc.toFixed(1)}%, æ¨¡å¼:${simMode}`);
      }).catch((error) => {
        pushBack('sim', `æ¨¡æ“¬ç‹€æ…‹ç™¼é€å¤±æ•—ï¼š${error.message}`);
      });
    }

    // ç™¼é€é›»æºæ¨¡æ“¬ç‹€æ…‹åˆ°ESP32ï¼ˆESP32æ¨¡å¼ä½¿ç”¨ï¼‰
    async function sendPowerSimulationState() {
      if (!SIM.enabled) return Promise.resolve();

      // ç²å–ç•¶å‰æ™‚é–“ - é—œéµä¿®å¾©ï¼šç¢ºä¿ESP32æ¨¡å¼ä½¿ç”¨æ­£ç¢ºçš„æ™‚é–“
      const currentTime = mockNow ? mockNow : new Date(); // æ˜ç¢ºä½¿ç”¨æ¨¡æ“¬æ™‚é–“æˆ–çœŸå¯¦æ™‚é–“

      // è¨ˆç®—æ™‚æ®µç‹€æ…‹ - ä½¿ç”¨èˆ‡æœ¬åœ°æ¨¡æ“¬ç›¸åŒçš„é‚è¼¯
      const hour = currentTime.getHours();
      const minute = currentTime.getMinutes();
      // å‚™æ´æ™‚æ®µï¼š12:30-12:59ï¼ˆèˆ‡isBackupWindowå‡½æ•¸é‚è¼¯ä¸€è‡´ï¼‰
      const isBackupPeriod = (hour === 12 && minute >= 30);

      // åªç™¼é€é›»æºç›¸é—œçš„æ¨¡æ“¬ç‹€æ…‹ï¼Œä¸åŒ…å«é›»æ± æ•¸æ“š
      const powerState = {
        grid_power: simGridPower,
        mode: simMode,
        supply: simSupply,
        timestamp: currentTime.getTime(),
        current_hour: hour,
        current_minute: minute,
        current_second: currentTime.getSeconds(),
        is_mock_time: mockNow !== null,
        is_backup_period: isBackupPeriod, // æ˜ç¢ºå‘ŠçŸ¥ESP32ç•¶å‰æ™‚æ®µç‹€æ…‹
        backup_start_hour: 12,
        backup_start_minute: 30,
        backup_end_hour: 13,
        backup_end_minute: 0,
        // ä¸ç™¼é€é›»æ± ç›¸é—œæ•¸æ“šï¼Œè®“ESP32ä½¿ç”¨çœŸå¯¦æ¸¬é‡å€¼
        simulation_type: 'power_only'
      };

      try {
        const response = await fetch(`${espIP}/power_simulation`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(powerState)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const timeStr = currentTime.toLocaleTimeString();
        const timeType = mockNow ? 'æ¨¡æ“¬' : 'çœŸå¯¦';
        const periodStatus = isBackupPeriod ? 'å‚™æ´æ™‚æ®µ' : 'å¸‚é›»æ™‚æ®µ';
        pushBack('sim', `ğŸ“¤ ESP32ç‹€æ…‹å·²ç™¼é€ï¼š${timeType}æ™‚é–“ ${timeStr}, ${periodStatus}, å¸‚é›»${simGridPower?'æ­£å¸¸':'ä¸­æ–·'}, ä¾›é›»:${simSupply}`);
        return Promise.resolve();
      } catch (error) {
        pushBack('sim', `âŒ ESP32ç‹€æ…‹ç™¼é€å¤±æ•—ï¼š${error.message}`);
        return Promise.reject(error);
      }
    }

    function sendCommand(target){
      if (SIM.enabled) {
        // æ¨¡æ“¬æ¨¡å¼ä¸‹ï¼Œæ›´æ–°æ¨¡æ“¬ç‹€æ…‹ä¸¦ç™¼é€åˆ°ESP32
        if (target === 'grid') {
          simSupply = 'grid';
        } else if (target === 'backup') {
          simSupply = 'backup';
        }
        sendSimulationState();
        pushBack('sim', `æ¨¡æ“¬å‘½ä»¤ï¼š${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
        return;
      }
      
      // éæ¨¡æ“¬æ¨¡å¼ï¼Œæ­£å¸¸ç™¼é€å‘½ä»¤
      pushBack('cmd', `æ­£åœ¨ç™¼é€åˆ‡æ›å‘½ä»¤åˆ°ESP32ï¼š${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);

      fetch(`${espIP}/${target}/on`, {
        method: 'GET',
        cache: 'no-store'
      }).then(response => {
        if (response.ok) {
          pushBack('cmd', `âœ… å‘½ä»¤å·²æˆåŠŸç™¼é€åˆ°ESP32ï¼š${target==='grid'?'å¸‚é›»':'å‚™æ´'}`);
          esp32Connected = true;
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      }).catch((error) => {
        pushBack('error', `âŒ å‘½ä»¤ç™¼é€å¤±æ•—ï¼š${target==='grid'?'å¸‚é›»':'å‚™æ´'} - ${error.message}`);
        pushBack('error', 'è«‹æª¢æŸ¥ESP32é€£æ¥ç‹€æ…‹å’Œç¶²è·¯è¨­å®š');
        esp32Connected = false;
      });
    }



    // ===== è‡ªå‹•æ¨¡å¼ =====
    // å¯¦æ©Ÿæ¨¡å¼é›»æ± ä¿è­·ç‹€æ…‹
    let realCritLock = false;         // å¯¦æ©Ÿå±éšªå……é›»é–
    let realCritEventSent = false;    // æ˜¯å¦å·²ç™¼é€å±éšªäº‹ä»¶
    let realCritNextRetryTs = 0;      // ä¸‹æ¬¡é‡è©¦æ™‚é–“æˆ³
    let realUserChoiceBeforeLock = null; // è¨˜ä½ç”¨æˆ¶åœ¨ä¿è­·è§¸ç™¼å‰çš„é¸æ“‡
    let lastRealSOC = null;           // æœ€å¾Œä¸€æ¬¡ç²å¾—çš„çœŸå¯¦SOC

    function evaluateAutoMode(fromTimer=false){
      // å¯¦æ©Ÿæ¨¡å¼å§‹çµ‚ä½¿ç”¨çœŸå¯¦æ™‚é–“ï¼Œä¸å—æ¨¡æ“¬æ™‚é–“å½±éŸ¿
      const now = new Date();
      const nowTs = Date.now();

      // ç²å–ç•¶å‰çœŸå¯¦SOCï¼ˆå¾æœ€å¾Œä¸€æ¬¡é™æ¸¬æ•¸æ“šï¼‰
      let currentSOC = lastRealSOC;

      // å¯¦æ©Ÿæ¨¡å¼é›»æ± ä¿è­·é‚è¼¯ï¼ˆèˆ‡æ¨¡æ“¬æ¨¡å¼ä¿æŒä¸€è‡´ï¼‰
      if (currentSOC !== null) {
        // 1) å±éšªé–ç‹€æ…‹ç®¡ç†
        if (currentSOC <= SETTINGS.sim.critThreshold && !realCritLock) {
          // é¦–æ¬¡è§¸ç™¼å……é›»ä¿è­·æ™‚ï¼Œè¨˜ä½ç”¨æˆ¶ç•¶å‰çš„é¸æ“‡
          if (mode === 'manual') {
            realUserChoiceBeforeLock = supply;
            pushBack('system', `ğŸ”’ å¯¦æ©Ÿä¿è­·ï¼šè¨˜ä½ç”¨æˆ¶é¸æ“‡${supply === 'grid' ? 'å¸‚é›»' : 'å‚™æ´'}ï¼Œå……é›»å®Œæˆå¾Œå°‡æ¢å¾©æ­¤é¸æ“‡`);
          } else {
            realUserChoiceBeforeLock = null; // è‡ªå‹•æ¨¡å¼ä¸éœ€è¦è¨˜ä½
          }
          realCritLock = true;
          pushBack('system', `ğŸš¨ å¯¦æ©Ÿé›»æ± ä¿è­·å•Ÿå‹•ï¼šSOC â‰¤ ${SETTINGS.sim.critThreshold}%`);
        }

        // 2) è§£é™¤å±éšªé–ï¼šSOC â‰¥ stopSoc ä¸”åœ¨å¸‚é›»å……é›»ç‹€æ…‹ä¸‹
        if (realCritLock && currentSOC >= SETTINGS.sim.stopSoc && gridPower && supply === 'grid') {
          realCritLock = false;
          realCritEventSent = false;
          pushBack('system', `âœ… å¯¦æ©Ÿé›»æ± å……é›»å®Œæˆï¼ˆSOC â‰¥ ${SETTINGS.sim.stopSoc}%ï¼‰`);
          pushBack('system', `ğŸ”“ å¯¦æ©Ÿé›»æ± ä¿è­·æ¨¡å¼å·²è§£é™¤ï¼Œæ‰‹å‹•æ§åˆ¶åŠŸèƒ½å·²æ¢å¾©`);

          // æ¢å¾©ç”¨æˆ¶åœ¨ä¿è­·è§¸ç™¼å‰çš„é¸æ“‡
          if (realUserChoiceBeforeLock && mode === 'manual') {
            // ä¸ç«‹å³åˆ‡æ›ï¼Œè€Œæ˜¯è¨˜éŒ„ç”¨æˆ¶åŸå§‹é¸æ“‡ä¾›å¾ŒçºŒåƒè€ƒ
            pushBack('system', `ğŸ“ ç”¨æˆ¶åŸå§‹é¸æ“‡å·²è¨˜éŒ„ï¼š${realUserChoiceBeforeLock === 'grid' ? 'å¸‚é›»' : 'å‚™æ´'}`);
            realUserChoiceBeforeLock = null; // æ¸…é™¤è¨˜éŒ„
          }
        }
      }

      let required = 'grid';
      let reason = '';

      // æ‰‹å‹•æ¨¡å¼ä¸‹çš„å±éšªé–æª¢æŸ¥ï¼ˆå®‰å…¨å„ªå…ˆï¼‰
      if (mode === 'manual') {
        // å±éšªé–æª¢æŸ¥ï¼šé›»æ± ä¿è­·æ¨¡å¼ä¸­å¼·åˆ¶å¸‚é›»å……é›»
        if (realCritLock && gridPower && supply !== 'grid') {
          // å¼·åˆ¶åˆ‡æ›åˆ°å¸‚é›»å……é›»ï¼ˆè¦†è“‹æ‰‹å‹•é¸æ“‡ï¼‰
          requestSwitch('grid', 'real_critical_to_grid', {bypass: true});
          pushBack('system', `ğŸ”’ å¯¦æ©Ÿé›»æ± ä¿è­·æ¨¡å¼ï¼šå¼·åˆ¶åˆ‡æ›åˆ°å¸‚é›»å……é›»ï¼Œæ‰‹å‹•æ§åˆ¶å·²é–å®š`);
          pushBack('system', `æç¤ºï¼šSOCæ¢å¾©åˆ° ${SETTINGS.sim.stopSoc}% å¾Œå°‡è‡ªå‹•è§£é–æ‰‹å‹•æ§åˆ¶`);
          updateDisplay();
          checkPendingSwitch();
          return;
        }
        
        // æ‰‹å‹•æ¨¡å¼ï¼šåªè™•ç†å¸‚é›»ç¬æ–·çš„å®‰å…¨åˆ‡æ›ï¼ˆå·²åœ¨ toggleGridPower è™•ç†ï¼‰
        updateDisplay();
        checkPendingSwitch();
        return;
      }

      // è‡ªå‹•æ¨¡å¼çš„å„ªå…ˆç´šé‚è¼¯ï¼ˆèˆ‡æ¨¡æ“¬æ¨¡å¼ä¿æŒä¸€è‡´ï¼‰
      // å„ªå…ˆç´š1ï¼šå±éšªé–ç‹€æ…‹ï¼ˆåŒ…å«å……é›»ä¸­æ–·æƒ…æ³ï¼‰
      if (currentSOC !== null && (realCritLock || currentSOC <= SETTINGS.sim.critThreshold)) {
        if (gridPower) {
          required = 'grid';
          const inBackupWindow = isBackupWindow(now);
          const currentTime = now.toTimeString().split(' ')[0];

          reason = realCritLock ?
            `å¯¦æ©Ÿé›»æ± ä¿è­·æ¨¡å¼ï¼šç¹¼çºŒå¸‚é›»å……é›»ï¼ˆSOC=${currentSOC.toFixed(1)}%ï¼‰` :
            inBackupWindow ?
              `å¯¦æ©Ÿå±éšªé–€æª»è§¸ç™¼ï¼ˆSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼‰ï¼Œé›»æ± å®‰å…¨å„ªå…ˆæ–¼å‚™æ´æ™‚æ®µï¼ˆ${currentTime}ï¼‰ï¼Œå¼·åˆ¶åˆ‡å›å¸‚é›»å……é›»` :
              `å¯¦æ©Ÿå±éšªé–€æª»è§¸ç™¼ï¼ˆSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼‰ï¼Œé›»æ± å®‰å…¨å„ªå…ˆï¼Œå¼·åˆ¶åˆ‡å›å¸‚é›»å……é›»`;
        } else {
          // å±éšªé–æˆ–å±éšªé–€æª»ä¸”å¸‚é›»ä¸å¯ç”¨ï¼šåœæ­¢ä¾›é›»ï¼Œç­‰å¾…å¸‚é›»æ¢å¾©
          required = 'grid'; // è¨­å®šç‚ºå¸‚é›»ï¼Œä½†å¯¦éš›ä¸Šæœƒå› ç‚ºå¸‚é›»ä¸å¯ç”¨è€Œç„¡æ³•ä¾›é›»

          if (nowTs >= realCritNextRetryTs) {
            const inBackupWindow = isBackupWindow(now);
            const currentTime = now.toTimeString().split(' ')[0];
            const timeContext = inBackupWindow ? `ï¼ˆå‚™æ´æ™‚æ®µ ${currentTime}ï¼‰` : `ï¼ˆ${currentTime}ï¼‰`;

            reason = realCritLock ?
              `å¯¦æ©Ÿé›»æ± ä¿è­·æ¨¡å¼ä¸­å¸‚é›»ä¸­æ–·${timeContext}ï¼Œåœæ­¢ä¾›é›»ç­‰å¾…å¸‚é›»æ¢å¾©ï¼ˆSOC=${currentSOC.toFixed(1)}%ï¼‰` :
              `å¯¦æ©Ÿå±éšªé–€æª»è§¸ç™¼ä¸”å¸‚é›»ä¸­æ–·${timeContext}ï¼Œé›»æ± å®‰å…¨å„ªå…ˆï¼Œåœæ­¢æ‰€æœ‰ä¾›é›»ä¿è­·é›»æ± `;
            
            pushBack('system', `ğŸš¨ ${reason}`);
            realCritNextRetryTs = nowTs + SETTINGS.sim.critRetryMs;
          }
        }
      }
      // å„ªå…ˆç´š2ï¼šå¸‚é›»ä¸­æ–·
      else if (!gridPower) {
        required = 'backup';
        reason = 'å¸‚é›»ä¸­æ–·ï¼Œåˆ‡æ›ç‚ºå‚™æ´';
      }
      // å„ªå…ˆç´š3ï¼šæ™‚æ®µæ§åˆ¶
      else if (isBackupWindow(now)) {
        required = 'backup';
        reason = 'å‚™æ´æ™‚æ®µï¼ˆ12:30-12:59ï¼‰';
      } else if (isJustOutWindow(now)) {
        required = 'grid';
        reason = 'å‚™æ´æ™‚æ®µçµæŸï¼Œåˆ‡å›å¸‚é›»';
      }
      // å„ªå…ˆç´š4ï¼šé è¨­å¸‚é›»
      else {
        required = 'grid';
        reason = 'æ­£å¸¸æ™‚æ®µï¼Œä½¿ç”¨å¸‚é›»';
      }

      if (supply !== required){
        requestSwitch(required, reason);
      }

      updateDisplay();
      checkPendingSwitch();
    }

    // æ¨¡æ“¬è‡ªå‹•æ¨¡å¼è©•ä¼°å‡½æ•¸ï¼ˆæ•´åˆå±éšªé–€æª»å„ªå…ˆç´šï¼‰
    function evaluateSimAutoMode(fromTimer=false){
      const now = getNow();

      // æ™‚é–“æ¨é€²ï¼ˆç„¡è«–æ‰‹å‹•é‚„æ˜¯è‡ªå‹•æ¨¡å¼éƒ½éœ€è¦ï¼‰
      if (mockNow && fromTimer) {
        const oldTime = mockNow.getTime();
        mockNow = new Date(mockNow.getTime() + 1000);

        // æª¢æŸ¥æ˜¯å¦è·¨è¶Šäº†é—œéµæ™‚é–“é»
        const oldHour = new Date(oldTime).getHours();
        const oldMinute = new Date(oldTime).getMinutes();
        const newHour = mockNow.getHours();
        const newMinute = mockNow.getMinutes();

        // å¦‚æœè·¨è¶Šäº†12:30æˆ–13:00ï¼Œä¸”æ˜¯è‡ªå‹•æ¨¡å¼ï¼Œé‡æ–°è©•ä¼°è‡ªå‹•æ¨¡å¼
        const crossedCriticalTime =
          (oldHour === 12 && oldMinute === 29 && newHour === 12 && newMinute === 30) || // é€²å…¥å‚™æ´æ™‚æ®µ
          (oldHour === 12 && oldMinute === 59 && newHour === 13 && newMinute === 0);    // é›¢é–‹å‚™æ´æ™‚æ®µ

        if (crossedCriticalTime && simMode === 'auto') {
          // é‡æ–°è©•ä¼°è‡ªå‹•æ¨¡å¼ï¼Œè§¸ç™¼æ™‚æ®µåˆ‡æ›é‚è¼¯
          evaluateSimAutoMode(false); // ä¸æ¨é€²æ™‚é–“ï¼Œåªé‡æ–°è©•ä¼°
        }
      }

      // æ‰‹å‹•æ¨¡å¼ä¸‹ä»éœ€æª¢æŸ¥å±éšªé–ï¼ˆå®‰å…¨å„ªå…ˆï¼‰
      if (simMode === 'manual') {
        // å±éšªé–æª¢æŸ¥ï¼šé›»æ± ä¿è­·æ¨¡å¼ä¸­å¼·åˆ¶å¸‚é›»å……é›»
        if (SIM.critLock && simGridPower && simSupply !== 'grid') {
          // å¼·åˆ¶åˆ‡æ›åˆ°å¸‚é›»å……é›»ï¼ˆè¦†è“‹æ‰‹å‹•é¸æ“‡ï¼‰
          simSupply = 'grid';
          pushBack('sim', `ğŸ”’ é›»æ± ä¿è­·æ¨¡å¼ï¼šå¼·åˆ¶åˆ‡æ›åˆ°å¸‚é›»å……é›»ï¼Œæ‰‹å‹•æ§åˆ¶å·²é–å®š`);
          pushBack('sim', `æç¤ºï¼šSOCæ¢å¾©åˆ° ${SETTINGS.sim.stopSoc}% å¾Œå°‡è‡ªå‹•è§£é–æ‰‹å‹•æ§åˆ¶`);

          // ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32
          if (SIM.enabled && getSimMode() === 'esp32') {
            sendPowerSimulationState();
          }
        }

        // æ‰‹å‹•æ¨¡å¼ä¸‹ä¹Ÿéœ€è¦ç™¼é€ç‹€æ…‹åˆ°ESP32å’Œæ›´æ–°é¡¯ç¤º
        if (SIM.enabled && getSimMode() === 'esp32') {
          sendPowerSimulationState();
          updateSimDisplay();
        }
        return; // å…¶ä»–æƒ…æ³ä¸‹æ‰‹å‹•æ¨¡å¼ä¸éœ€è¦è‡ªå‹•è©•ä¼°
      }

      let required = 'grid';
      let reason = '';

      // å„ªå…ˆç´š1ï¼šå±éšªé–ç‹€æ…‹ï¼ˆåŒ…å«å……é›»ä¸­æ–·æƒ…æ³ï¼‰
      if (SIM.critLock || SIM.soc <= SETTINGS.sim.critThreshold) {
        if (simGridPower) {
          required = 'grid';
          const now = getNow();
          const inBackupWindow = isBackupWindow(now);
          const currentTime = now.toTimeString().split(' ')[0];

          reason = SIM.critLock ?
            `é›»æ± ä¿è­·æ¨¡å¼ï¼šç¹¼çºŒå¸‚é›»å……é›»ï¼ˆSOC=${SIM.soc.toFixed(1)}%ï¼‰` :
            inBackupWindow ?
              `å±éšªé–€æª»è§¸ç™¼ï¼ˆSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼‰ï¼Œé›»æ± å®‰å…¨å„ªå…ˆæ–¼å‚™æ´æ™‚æ®µï¼ˆ${currentTime}ï¼‰ï¼Œå¼·åˆ¶åˆ‡å›å¸‚é›»å……é›»` :
              `å±éšªé–€æª»è§¸ç™¼ï¼ˆSOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼‰ï¼Œé›»æ± å®‰å…¨å„ªå…ˆï¼Œå¼·åˆ¶åˆ‡å›å¸‚é›»å……é›»`;
        } else {
          // å±éšªé–æˆ–å±éšªé–€æª»ä¸”å¸‚é›»ä¸å¯ç”¨ï¼šåœæ­¢ä¾›é›»ï¼Œç­‰å¾…å¸‚é›»æ¢å¾©
          required = 'grid'; // è¨­å®šç‚ºå¸‚é›»ï¼Œä½†å¯¦éš›ä¸Šæœƒå› ç‚ºå¸‚é›»ä¸å¯ç”¨è€Œç„¡æ³•ä¾›é›»

          const inBackupWindow = isBackupWindow(now);
          const currentTime = now.toTimeString().split(' ')[0];
          const timeContext = inBackupWindow ? `ï¼ˆå‚™æ´æ™‚æ®µ ${currentTime}ï¼‰` : `ï¼ˆ${currentTime}ï¼‰`;

          reason = SIM.critLock ?
            `é›»æ± ä¿è­·æ¨¡å¼ä¸­å¸‚é›»ä¸­æ–·${timeContext}ï¼Œåœæ­¢ä¾›é›»ç­‰å¾…å¸‚é›»æ¢å¾©ï¼ˆSOC=${SIM.soc.toFixed(1)}%ï¼‰` :
            `å±éšªé–€æª»è§¸ç™¼ä¸”å¸‚é›»ä¸­æ–·${timeContext}ï¼Œé›»æ± å®‰å…¨å„ªå…ˆï¼Œåœæ­¢æ‰€æœ‰ä¾›é›»ä¿è­·é›»æ± `;
        }
      }
      // å„ªå…ˆç´š2ï¼šå¸‚é›»ä¸­æ–·
      else if (!simGridPower) {
        required = 'backup';
        reason = 'å¸‚é›»ä¸­æ–·ï¼Œåˆ‡æ›ç‚ºå‚™æ´';
      }
      // å„ªå…ˆç´š3ï¼šæ™‚æ®µæ§åˆ¶
      else if (isBackupWindow(now)) {
        required = 'backup';
        reason = 'å‚™æ´æ™‚æ®µï¼ˆ12:30-12:59ï¼‰';
      } else if (isJustOutWindow(now)) {
        required = 'grid';
        reason = 'å‚™æ´æ™‚æ®µçµæŸï¼Œåˆ‡å›å¸‚é›»';
      }
      // å„ªå…ˆç´š4ï¼šé è¨­å¸‚é›»
      else {
        required = 'grid';
        reason = 'æ­£å¸¸æ™‚æ®µï¼Œä½¿ç”¨å¸‚é›»';
      }

      if (simSupply !== required){
        const oldSupply = simSupply;
        simSupply = required;
        pushBack('sim', `ğŸ”„ æ¨¡æ“¬è‡ªå‹•åˆ‡æ›ï¼š${oldSupply==='grid'?'å¸‚é›»':'å‚™æ´'} â†’ ${required==='grid'?'å¸‚é›»':'å‚™æ´'}ï¼ˆ${reason}ï¼‰`);
      }



      // ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32ï¼ˆåœ¨æ™‚é–“æ¨é€²å’Œé‡æ–°è©•ä¼°å¾Œï¼‰
      if (SIM.enabled && getSimMode() === 'esp32') {
        sendPowerSimulationState();
      }

      // ESP32æ¨¡å¼ä¸‹æ›´æ–°é¡¯ç¤ºï¼ˆç´”æœ¬åœ°æ¨¡æ“¬æœ‰è‡ªå·±çš„é¡¯ç¤ºæ›´æ–°é‚è¼¯ï¼‰
      if (SIM.enabled && getSimMode() === 'esp32') {
        updateSimDisplay();
      }
    }
    
    // å®šæ™‚åŸ·è¡Œè‡ªå‹•æ¨¡å¼è©•ä¼°
    setInterval(()=>evaluateAutoMode(true),1000);
    setInterval(()=>evaluateSimAutoMode(true),1000);
    
    // å®šæ™‚åŸ·è¡Œæ¨¡æ“¬æ•¸æ“šæ›´æ–°ï¼ˆç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼ï¼‰
    setInterval(()=>{
      if (SIM.enabled && getSimMode() === 'local') {
        // 1. åŸ·è¡Œæ¨¡æ“¬é‹ç®—
        const simData = simStep();

        // 2. æ›´æ–°æ¨¡æ“¬æ§åˆ¶é …é¡¯ç¤º
        updateSimLabels();

        // 3. æ¸²æŸ“é™æ¸¬æ•¸æ“šåˆ°å„å€‹é é¢
        renderTelemetry(applyCalib(simData), true);

        // 4. æ›´æ–°æ¨¡æ“¬æ¸¬è©¦é é¢é¡¯ç¤º
        updateSimDisplay();

        // 5. ç¢ºä¿æ§åˆ¶å°é é¢ä¹Ÿæ›´æ–°
        updateDisplay();
      }
    }, 1000);

    // ===== Telemetryï¼ˆå«æ¨¡æ“¬ï¼‰ =====
    let boostUntil = 0;
    function paintSocBar(p){
      const bar=$('soc-bar');
      if (!bar) return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨å°±è·³éï¼ˆç³»çµ±ä»‹ç´¹é é¢æ²’æœ‰é€™å€‹å…ƒç´ ï¼‰

      const pct=Math.max(0,Math.min(100,Number.isFinite(p)?p:0));
      bar.style.width=pct+'%';
      bar.className='h-2 rounded-full '+(pct<=SETTINGS.sim.socThreshold?'bg-red-500':pct<=SETTINGS.sim.socThreshold+10?'bg-yellow-500':'bg-green-500');
    }

    const SIM = {
      enabled:false,
      soc:78.0, currentA:0.0, sensor_fault:false,
      overrideSoc:false, overrideI:false, draggingSoc:false, draggingI:false,
      critLock:false,           // å±éšªå……é›»é–ï¼ˆç›´åˆ° stopSocï¼‰
      critEventSent:false,
      chargerEn:false,          // å……é›»å™¨ä½¿èƒ½ï¼ˆæ¨¡æ“¬ï¼‰
      critNextRetryTs:0,
      userChoiceBeforeLock: null // è¨˜ä½ç”¨æˆ¶åœ¨ä¿è­·è§¸ç™¼å‰çš„é¸æ“‡
    };

    function toggleSim(){
      SIM.enabled=!SIM.enabled;
      if (SIM.enabled){
        boostUntil=Date.now()+2000;
        // æ›´æ–°æ¨¡æ“¬é–‹é—œæŒ‰éˆ•
        const btn = $('sim-toggle-btn');
        if (btn) {
          btn.innerHTML = '<div class="flex items-center justify-center"><span class="text-base mr-2">ğŸ”„</span><span class="text-sm font-semibold">é—œé–‰æ¨¡æ“¬æ¨¡å¼</span></div>';
          btn.className = 'btn w-full bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium py-2 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105';
        }

        const currentSimMode = getSimMode();

        if (currentSimMode === 'local') {
          // ç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼ï¼šåˆå§‹åŒ–æ¨¡æ“¬æ•¸æ“šï¼Œä½†ä¸ç«‹å³æ›´æ–°é¡¯ç¤ºï¼ˆç”±å®šæ™‚å™¨è² è²¬ï¼‰
          const simData = simStep();
        } else {
          // ESP32æ¨¡å¼ï¼šå…ˆæ¸…ç©ºé¡¯ç¤ºï¼Œç­‰å¾…ESP32çœŸå¯¦æ•¸æ“š
          renderTelemetry({soc:null, v:null, i:null, sensor_fault:false}, false);

          // ç«‹å³è§¸ç™¼ä¸€æ¬¡æ•¸æ“šç²å–ï¼Œé€™æœƒç™¼é€é›»æºç‹€æ…‹ä¸¦ç­‰å¾…ESP32å›æ‡‰
          fetchTelemetry();
        }
      } else {
        // æ›´æ–°æ¨¡æ“¬é–‹é—œæŒ‰éˆ•
        const btn = $('sim-toggle-btn');
        if (btn) {
          btn.innerHTML = '<div class="flex items-center justify-center"><span class="text-base mr-2">ğŸ§ª</span><span class="text-sm font-semibold">é–‹å•Ÿæ¨¡æ“¬æ¨¡å¼</span></div>';
          btn.className = 'btn w-full bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-medium py-2 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105';
        }
        // ç«‹å³è§¸ç™¼ä¸€æ¬¡å¯¦æ©Ÿæ•¸æ“šæ›´æ–°
        fetchTelemetry();
      }
      pushBack('mode', 'æ¨¡æ“¬åˆ‡æ›ç‚ºï¼š'+(SIM.enabled?'é–‹':'é—œ'));
    }

    // å¹³æ»‘æ›´æ–°å…ƒç´ å…§å®¹å’Œæ¨£å¼
    function smoothUpdateElement(element, newText, newClassName) {
      if (!element) return;

      // å¦‚æœå…§å®¹æ²’æœ‰æ”¹è®Šï¼Œåªæ›´æ–°æ¨£å¼
      if (element.textContent === newText) {
        if (newClassName && element.className !== newClassName) {
          element.className = newClassName;
        }
        return;
      }

      // å…§å®¹æœ‰æ”¹è®Šæ™‚ï¼Œä½¿ç”¨æ·¡å…¥æ·¡å‡ºæ•ˆæœ
      element.style.opacity = '0.6';
      element.style.transform = 'scale(0.98)';

      setTimeout(() => {
        element.textContent = newText;
        if (newClassName) {
          element.className = newClassName;
        }
        element.style.opacity = '1';
        element.style.transform = 'scale(1)';

        // ç‚ºæ•¸å­—å…ƒç´ æ·»åŠ è®ŠåŒ–å‹•ç•«
        if (element.classList.contains('smooth-number')) {
          element.classList.add('number-change');
          setTimeout(() => {
            element.classList.remove('number-change');
          }, 300);
        }

        // ç‚ºç‹€æ…‹å…ƒç´ æ·»åŠ è®ŠåŒ–å‹•ç•«
        if (element.classList.contains('smooth-text')) {
          element.classList.add('status-change');
          setTimeout(() => {
            element.classList.remove('status-change');
          }, 400);
        }
      }, 100);
    }

    // SOCå°ˆç”¨å¹³æ»‘æ›´æ–°å‡½æ•¸ï¼ˆé˜²æ­¢é »é–ƒï¼‰
    function smoothUpdateSOC(element, socValue, unit = ' %') {
      if (!element) return;

      const newText = (socValue != null && Number.isFinite(socValue)) ?
        socValue.toFixed(1) + unit :
        '--' + unit;

      // å¦‚æœå…§å®¹æ²’æœ‰æ”¹è®Šï¼Œä¸åšä»»ä½•æ“ä½œ
      if (element.textContent === newText) {
        return;
      }

      // SOCè®ŠåŒ–ä½¿ç”¨æ›´æº«å’Œçš„éæ¸¡æ•ˆæœ
      element.style.opacity = '0.85';
      setTimeout(() => {
        element.textContent = newText;
        element.style.opacity = '1';
      }, 50); // æ›´çŸ­çš„å»¶é²ï¼Œæ›´å¹³æ»‘
    }

    // æ¨¡æ“¬é¡¯ç¤ºæ›´æ–°å‡½æ•¸
    function updateSimDisplay(){
      // æ›´æ–°æ¨¡æ“¬æ¸¬è©¦é é¢çš„ç‹€æ…‹é¡¯ç¤º
      const simCurrentMode = $('sim-current-mode');
      const simCurrentPower = $('sim-current-power');
      const simCurrentGrid = $('sim-current-grid');
      
      // ä½¿ç”¨å¹³æ»‘æ›´æ–°å‡½æ•¸
      smoothUpdateElement(
        simCurrentMode,
        simMode === 'manual' ? 'æ‰‹å‹•' : 'è‡ªå‹•',
        `font-semibold px-2 py-1 rounded-md text-sm status-text smooth-text ${simMode === 'manual' ? 'text-orange-600 bg-orange-50' : 'text-blue-600 bg-blue-50'}`
      );

      smoothUpdateElement(
        simCurrentPower,
        simSupply === 'grid' ? 'å¸‚é›»' : 'å‚™æ´',
        `font-semibold px-2 py-1 rounded-md text-sm status-text smooth-text ${simSupply === 'grid' ? 'text-blue-600 bg-blue-50' : 'text-green-600 bg-green-50'}`
      );

      smoothUpdateElement(
        simCurrentGrid,
        simGridPower ? 'æ­£å¸¸' : 'ä¸­æ–·',
        `font-semibold px-2 py-1 rounded-md text-sm status-text smooth-text ${simGridPower ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}`
      );
    }

    function simReset(){
      Object.assign(SIM, { soc:78.0, currentA:0.0, overrideSoc:false, overrideI:false, critLock:false, critEventSent:false, chargerEn:false, critNextRetryTs:0, userChoiceBeforeLock:null });

      // é‡è¨­æ§åˆ¶æ¢å€¼ï¼ˆåŠ å…¥å®‰å…¨æª¢æŸ¥ï¼‰
      const socSlider = $('sim-soc');
      const currentSlider = $('sim-i');
      if (socSlider) socSlider.value = SIM.soc;
      if (currentSlider) currentSlider.value = SIM.currentA;

      updateSimLabels();
      pushBack('sim', 'é‡è¨­æ¨¡æ“¬åƒæ•¸');
    }

    function ocvFromSocBase(s){
      const p=Math.max(0,Math.min(100,s));
      if (p>=100) return 12.60;
      if (p>=90)  return 12.50+(p-90)*(12.60-12.50)/10;
      if (p>=80)  return 12.42+(p-80)*(12.50-12.42)/10;
      if (p>=70)  return 12.32+(p-70)*(12.42-12.32)/10;
      if (p>=60)  return 12.20+(p-60)*(12.32-12.20)/10;
      if (p>=50)  return 12.06+(p-50)*(12.20-12.06)/10;
      if (p>=40)  return 11.90+(p-40)*(12.06-11.90)/10;
      if (p>=30)  return 11.75+(p-30)*(11.90-11.75)/10;
      return 11.50+(p-0 )*(11.75-11.50)/30;
    }
    function ocvFromSoc(s){ return ocvFromSocBase(s)*SETTINGS.sim.ocvGain + SETTINGS.sim.ocvOffset; }

    function pushSimInstantRender(){
      const onGrid = (simSupply === 'grid' && simGridPower);
      const onBackup = (simSupply === 'backup'); // å‚™æ´æ¨¡å¼ï¼ˆä¸ç®¡å¸‚é›»ç‹€æ…‹ï¼‰
      const isCharging = (simGridPower && onGrid && SIM.chargerEn);
      const emergencyStop = (SIM.soc <= SETTINGS.sim.critThreshold && !simGridPower);

      let state;
      if (emergencyStop) {
        state = 'EMERGENCY_STOP'; // ç·Šæ€¥åœæ­¢ç‹€æ…‹
      } else if (isCharging) {
        state = 'GRID_CHG'; // å¸‚é›»å……é›»
      } else if (onGrid) {
        state = 'GRID'; // å¸‚é›»ä¾›é›»
      } else if (onBackup) {
        state = 'ISLAND_RUN'; // å‚™æ´ä¾›é›»
      } else {
        state = 'OFFLINE'; // é›¢ç·šç‹€æ…‹
      }

      const d={ ts:Date.now(), soc:SIM.soc, v: ocvFromSoc(SIM.soc)+SIM.currentA*SETTINGS.sim.Rint, i:SIM.currentA,
        state:state, grid_charging:isCharging, sensor_fault:SIM.sensor_fault, last_event:null };
      renderTelemetry(applyCalib(d), true); boostUntil=Date.now()+SETTINGS.net.boostHoldMs;
    }

    function simStep(){
      const nowTs = Date.now();

      // 0) æ™‚é–“æ¨é€²ï¼ˆç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼ï¼‰
      if (mockNow) {
        const oldTime = mockNow.getTime();
        mockNow = new Date(mockNow.getTime() + 1000);

        // æª¢æŸ¥æ˜¯å¦è·¨è¶Šäº†é—œéµæ™‚é–“é»
        const oldHour = new Date(oldTime).getHours();
        const oldMinute = new Date(oldTime).getMinutes();
        const newHour = mockNow.getHours();
        const newMinute = mockNow.getMinutes();

        // å¦‚æœè·¨è¶Šäº†12:30æˆ–13:00ï¼Œä¸”æ˜¯è‡ªå‹•æ¨¡å¼ï¼Œé‡æ–°è©•ä¼°è‡ªå‹•æ¨¡å¼
        const crossedCriticalTime =
          (oldHour === 12 && oldMinute === 29 && newHour === 12 && newMinute === 30) || // é€²å…¥å‚™æ´æ™‚æ®µ
          (oldHour === 12 && oldMinute === 59 && newHour === 13 && newMinute === 0);    // é›¢é–‹å‚™æ´æ™‚æ®µ

        if (crossedCriticalTime && simMode === 'auto') {
          // é‡æ–°è©•ä¼°è‡ªå‹•æ¨¡å¼ï¼Œè§¸ç™¼æ™‚æ®µåˆ‡æ›é‚è¼¯
          evaluateSimAutoMode(false); // ä¸æ¨é€²æ™‚é–“ï¼Œåªé‡æ–°è©•ä¼°
        }
      }

      // 1) å±éšªé–ç‹€æ…‹ç®¡ç†
      if (SIM.soc <= SETTINGS.sim.critThreshold && !SIM.critLock) {
        // é¦–æ¬¡è§¸ç™¼å……é›»ä¿è­·æ™‚ï¼Œè¨˜ä½ç”¨æˆ¶ç•¶å‰çš„é¸æ“‡
        if (simMode === 'manual') {
          SIM.userChoiceBeforeLock = simSupply;
          pushBack('sim', `ğŸ”’ è¨˜ä½ç”¨æˆ¶é¸æ“‡ï¼š${simSupply === 'grid' ? 'å¸‚é›»' : 'å‚™æ´'}ï¼Œå……é›»å®Œæˆå¾Œå°‡æ¢å¾©æ­¤é¸æ“‡`);
        } else {
          SIM.userChoiceBeforeLock = null; // è‡ªå‹•æ¨¡å¼ä¸éœ€è¦è¨˜ä½
        }
        SIM.critLock = true;
      }

      // 2) å……é›»é‚è¼¯ï¼ˆä¸æ§åˆ¶ä¾›é›»åˆ‡æ›ï¼Œç”± evaluateSimAutoMode æ§åˆ¶ï¼‰
      if (SIM.critLock){
        // å±éšªé–ï¼šåªè¦åœ¨å¸‚é›»å°±å……é›»
        if (simGridPower && simSupply === 'grid'){
          SIM.chargerEn = true;
          if (!SIM.critEventSent){
            pushBack('sim', `SOC â‰¤ ${SETTINGS.sim.critThreshold}%ï¼šæ¨¡æ“¬å¼·åˆ¶å¸‚é›»å……é›»`);
            SIM.critEventSent = true;
          }
        } else {
          SIM.chargerEn = false;
          if (nowTs >= SIM.critNextRetryTs){
            const currentTime = getNow().toTimeString().split(' ')[0];
            const inBackupWindow = isBackupWindow(getNow());
            const timeContext = inBackupWindow ? `ï¼ˆå‚™æ´æ™‚æ®µ ${currentTime}ï¼‰` : `ï¼ˆ${currentTime}ï¼‰`;
            pushBack('sim', `ğŸš¨ ç·Šæ€¥åœæ­¢ï¼šSOC â‰¤ ${SETTINGS.sim.critThreshold}% ä¸”å¸‚é›»ä¸­æ–·${timeContext}ï¼Œé›»æ± å®‰å…¨å„ªå…ˆï¼Œå·²åœæ­¢æ‰€æœ‰ä¾›é›»ä¿è­·é›»æ± `);
            SIM.critNextRetryTs = nowTs + SETTINGS.sim.critRetryMs;
          }
        }
      } else {
        // éå±éšªé–ï¼šåœ¨å¸‚é›»ä¸‹è‡ªå‹•å……é›»ï¼ˆSOC < åœå…… SOCï¼‰
        if (simGridPower && simSupply === 'grid'){
          SIM.chargerEn = SIM.soc < SETTINGS.sim.stopSoc;
        } else {
          SIM.chargerEn = false;
        }
      }

      // 4) è§£é™¤å±éšªé–ï¼šå¿…é ˆåœ¨å¸‚é›»å……é›»ç‹€æ…‹ä¸‹ä¸”SOC â‰¥ stopSoc
      if (SIM.critLock && SIM.chargerEn && SIM.soc >= SETTINGS.sim.stopSoc && simGridPower){
        SIM.chargerEn = false;
        SIM.critLock = false;
        SIM.critEventSent = false;
        pushBack('sim', `âœ… é›»æ± å……é›»å®Œæˆï¼ˆSOC â‰¥ ${SETTINGS.sim.stopSoc}%ï¼‰ï¼Œå·²åœæ­¢å……é›»`);
        pushBack('sim', `ğŸ”“ é›»æ± ä¿è­·æ¨¡å¼å·²è§£é™¤ï¼Œæ‰‹å‹•æ§åˆ¶åŠŸèƒ½å·²æ¢å¾©`);

        // æ¢å¾©ç”¨æˆ¶åœ¨ä¿è­·è§¸ç™¼å‰çš„é¸æ“‡
        if (SIM.userChoiceBeforeLock && simMode === 'manual') {
          simSupply = SIM.userChoiceBeforeLock;
          pushBack('sim', `ğŸ”„ æ¢å¾©ç”¨æˆ¶åŸå§‹é¸æ“‡ï¼šåˆ‡æ›ç‚º${simSupply === 'grid' ? 'å¸‚é›»' : 'å‚™æ´'}`);
          SIM.userChoiceBeforeLock = null; // æ¸…é™¤è¨˜éŒ„
        }
      }

      // 5) é›»æµè¨ˆç®—ï¼šè¦†å¯«æˆ–ä¸€éšæ…£æ€§è·Ÿè¿½
      const onGrid = (simSupply === 'grid' && simGridPower); // å¿…é ˆå¸‚é›»å¯ç”¨æ‰ç®—åœ¨å¸‚é›»
      const onBackup = (simSupply === 'backup'); // å‚™æ´æ¨¡å¼ï¼ˆä¸ç®¡å¸‚é›»ç‹€æ…‹ï¼‰
      const isCharging = (simGridPower && onGrid && SIM.chargerEn);

      // å±éšªé–€æª»ä¿è­·ï¼šSOCéä½ä¸”å¸‚é›»ä¸å¯ç”¨æ™‚ï¼Œåœæ­¢æ‰€æœ‰ä¾›é›»
      const emergencyStop = (SIM.soc <= SETTINGS.sim.critThreshold && !simGridPower);

      if (SIM.overrideI){
        SIM.currentA = parseFloat($('sim-i').value);
      } else {
        let targetI = 0; // é è¨­ç„¡é›»æµ

        if (emergencyStop) {
          targetI = 0; // ç·Šæ€¥åœæ­¢ï¼šç„¡é›»æµ
        } else if (isCharging) {
          targetI = SETTINGS.sim.Ichg; // å……é›»é›»æµ
        } else if (onBackup) {
          targetI = SETTINGS.sim.Idis; // å‚™æ´æ”¾é›»é›»æµ
        }
        // å…¶ä»–æƒ…æ³ï¼ˆå¸‚é›»ä¸å……é›»ï¼‰ï¼štargetI = 0

        if (!SIM.draggingI){
          SIM.currentA += (targetI - SIM.currentA) * 0.35;
          // åªæœ‰åœ¨éæ‹–å‹•ç‹€æ…‹ä¸‹æ‰æ›´æ–°æ»‘æ¡¿å€¼ï¼Œé¿å…èˆ‡ç”¨æˆ¶æ“ä½œè¡çª
          const currentSlider = $('sim-i');
          if (currentSlider) currentSlider.value = SIM.currentA.toFixed(1);
        }
      }

      // 6) SOCè¨ˆç®—ï¼šè¦†å¯«æˆ–è‡ªå‹•æ¼”é€²
      if (SIM.overrideSoc){
        SIM.soc = parseFloat($('sim-soc').value);

      } else if (!SIM.draggingSoc){
        let dSoc = 0;

        if (emergencyStop) {
          dSoc = 0; // ç·Šæ€¥åœæ­¢ï¼šSOCä¸è®Šï¼ˆä¿è­·é›»æ± ï¼‰
        } else if (SIM.critLock && onBackup) {
          dSoc = 0; // é›»æ± ä¿è­·æ¨¡å¼ï¼šç¦æ­¢æ”¾é›»ï¼Œå³ä½¿åœ¨å‚™æ´æ¨¡å¼ä¸‹ä¹Ÿä¸æ”¾é›»
          if (!SIM.critEventSent) {
            pushBack('sim', `ğŸ”’ é›»æ± ä¿è­·æ¨¡å¼ï¼šç¦æ­¢æ”¾é›»ï¼ŒSOCä¿æŒåœ¨ ${SIM.soc.toFixed(1)}%`);
          }
        } else if (isCharging) {
          dSoc = SETTINGS.sim.dSocChg; // å……é›»ï¼š+0.15%/s
        } else if (onBackup) {
          dSoc = SETTINGS.sim.dSocDis; // å‚™æ´ï¼š-0.20%/s
        }
        // å…¶ä»–æƒ…æ³ï¼ˆå¸‚é›»ä¸å……é›»ï¼‰ï¼šdSoc = 0ï¼ˆSOCä¸è®Šï¼‰

        SIM.soc = Math.max(0, Math.min(100, SIM.soc + dSoc));
        // åªæœ‰åœ¨éæ‹–å‹•ç‹€æ…‹ä¸‹æ‰æ›´æ–°æ»‘æ¡¿å€¼ï¼Œé¿å…èˆ‡ç”¨æˆ¶æ“ä½œè¡çª
        if (!SIM.draggingSoc) {
          const socSlider = $('sim-soc');
          if (socSlider) socSlider.value = SIM.soc.toFixed(1);
        }
      }

      // 7) é›»å£“è¨ˆç®—ï¼šV = OCV(SOC) + I * Rint + eps
      const v = ocvFromSoc(SIM.soc) + SIM.currentA * SETTINGS.sim.Rint + (Math.random()-0.5)*SETTINGS.sim.noiseV;

      // 8) ä¸€èˆ¬é–€æª»æç¤ºï¼ˆéå±éšªé–ä¸”éå……é›»æ™‚ï¼‰
      if (!SIM.critLock && !isCharging){
        if (SIM.soc <= SETTINGS.sim.socThreshold){
          pushBack('sim', `SOC â‰¤ ${SETTINGS.sim.socThreshold}%ï¼šæ¨¡æ“¬å»ºè­°åˆ‡å›å¸‚é›»å……é›»`);
        }
      }

      // æ³¨æ„ï¼šä¸åœ¨é€™è£¡èª¿ç”¨ updateSimLabels() å’Œ updateSimDisplay()
      // é¿å…èˆ‡å¤–éƒ¨å®šæ™‚å™¨è¡çªï¼Œç”±èª¿ç”¨æ–¹è² è²¬æ›´æ–°é¡¯ç¤º

      // å®šæœŸç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32ï¼ˆæ¯5ç§’ï¼Œåƒ…ESP32æ¨¡å¼ï¼‰
      if (SIM.enabled && getSimMode() === 'esp32' && (nowTs % 5000) < 1000) {
        sendSimulationState();
      }

      // ç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼çš„å®šæœŸæ—¥èªŒï¼ˆæ¯10ç§’ï¼‰
      if (SIM.enabled && getSimMode() === 'local' && (nowTs % 10000) < 1000) {
        pushBack('sim', `ç´”æœ¬åœ°æ¨¡æ“¬é‹è¡Œä¸­ - SOC: ${SIM.soc.toFixed(1)}%, é›»æµ: ${SIM.currentA.toFixed(1)}A, ä¾›é›»: ${simSupply === 'grid' ? 'å¸‚é›»' : 'å‚™æ´'}`);
      }

      // è¿”å›ESP32æ ¼å¼çš„æ•¸æ“š
      let state;
      if (emergencyStop) {
        state = 'EMERGENCY_STOP'; // ç·Šæ€¥åœæ­¢ç‹€æ…‹
      } else if (isCharging) {
        state = 'GRID_CHG'; // å¸‚é›»å……é›»
      } else if (onGrid) {
        state = 'GRID'; // å¸‚é›»ä¾›é›»
      } else if (onBackup) {
        state = 'ISLAND_RUN'; // å‚™æ´ä¾›é›»
      } else {
        state = 'OFFLINE'; // é›¢ç·šç‹€æ…‹
      }

      return {
        ts: nowTs,                    // ms since epoch
        soc: SIM.soc,                 // %
        v: v,                         // Vï¼ˆæœªæ ¡æ­£å‰ï¼‰
        i: SIM.currentA,              // Aï¼ˆæœªæ ¡æ­£å‰ï¼‰
        state: state,
        grid_charging: isCharging,    // æ˜¯å¦åœ¨å¸‚é›»ä¸‹å……é›»
        sensor_fault: SIM.sensor_fault,
        last_event: null              // ï¼ˆä¿ç•™æ¬„ä½ï¼‰
      };
    }

    function updateSimLabels(){
      // ä½¿ç”¨å¹³æ»‘æ›´æ–°SOCé¡¯ç¤ºï¼ˆåŠ å…¥å®‰å…¨æª¢æŸ¥ï¼‰
      const socElement = $('sim-soc-val');
      if (socElement) {
        smoothUpdateSOC(socElement, SIM.soc, '%');
      }

      const iElement = $('sim-i-val');
      if (iElement) {
        const iTxt = Number.isFinite(SIM.currentA) ? SIM.currentA.toFixed(1) + ' A' : '-- A';
        const statusTxt = SIM.currentA > 0 ? 'ï¼ˆå……é›»ï¼‰' : (SIM.currentA < 0 ? 'ï¼ˆæ”¾é›»ï¼‰' : '');
        iElement.textContent = iTxt + statusTxt;
      }
    }

    // æ»‘æ¡¿ï¼šSOC æ§åˆ¶
    function attachSocHandlers(){
      const slider=$('sim-soc'); if (!slider) return;

      slider.addEventListener('input', ()=>{
        SIM.soc=parseFloat(slider.value);
        updateSimLabels();
        if (SIM.enabled) pushSimInstantRender();
      });

      // é–‹å§‹æ‹–å‹•æ™‚è¨­ç½®ç‹€æ…‹
      ['pointerdown','mousedown','touchstart'].forEach(e=>slider.addEventListener(e, ()=>{
        SIM.draggingSoc=true;
      },{passive:true}));

      // çµæŸæ‹–å‹•æ™‚æ¸…é™¤ç‹€æ…‹
      ['pointerup','mouseup','touchend','mouseleave'].forEach(e=>slider.addEventListener(e, ()=>{
        setTimeout(() => {
          SIM.draggingSoc=false;
        }, 100); // çŸ­æš«å»¶é²é¿å…ç«‹å³è¢«è¦†è“‹
      },{passive:true}));
    }
    // æ»‘æ¡¿ï¼šé›»æµæ§åˆ¶
    function attachIHandlers(){
      const slider=$('sim-i'); if (!slider) return;

      slider.addEventListener('input', ()=>{
        SIM.currentA=parseFloat(slider.value);
        updateSimLabels();
        if (SIM.enabled) pushSimInstantRender();
      });

      // é–‹å§‹æ‹–å‹•æ™‚è¨­ç½®ç‹€æ…‹
      ['pointerdown','mousedown','touchstart'].forEach(e=>slider.addEventListener(e, ()=>{
        SIM.draggingI=true;
      },{passive:true}));

      // çµæŸæ‹–å‹•æ™‚æ¸…é™¤ç‹€æ…‹
      ['pointerup','mouseup','touchend','mouseleave'].forEach(e=>slider.addEventListener(e, ()=>{
        setTimeout(() => {
          SIM.draggingI=false;
        }, 100); // çŸ­æš«å»¶é²é¿å…ç«‹å³è¢«è¦†è“‹
      },{passive:true}));
    }

    // æ¨¡æ“¬æ¨¡å¼é¸é …è™•ç†
    function attachSimModeHandlers() {
      const esp32Radio = document.querySelector('input[name="sim-mode"][value="esp32"]');
      const localRadio = document.querySelector('input[name="sim-mode"][value="local"]');
      
      if (esp32Radio && localRadio) {
        esp32Radio.addEventListener('change', () => {
          if (esp32Radio.checked) {
            pushBack('sim', 'åˆ‡æ›ç‚ºï¼šç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32æ¨¡å¼ï¼ˆä½¿ç”¨çœŸå¯¦ç¡¬é«”æ•¸æ“šï¼‰');
            updateSimulationPageTitle(); // æ›´æ–°é é¢æ¨™é¡Œå’Œéš±è—åƒæ•¸æ§åˆ¶
            // ç«‹å³è§¸ç™¼ä¸€æ¬¡æ•¸æ“šæ›´æ–°
            if (SIM.enabled) {
              fetchTelemetry();
            }
          }
        });
        
        localRadio.addEventListener('change', () => {
          if (localRadio.checked) {
            pushBack('sim', 'åˆ‡æ›ç‚ºï¼šç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼ï¼ˆä½¿ç”¨åƒæ•¸æ§åˆ¶ï¼‰');
            updateSimulationPageTitle(); // æ›´æ–°é é¢æ¨™é¡Œå’Œé¡¯ç¤ºåƒæ•¸æ§åˆ¶
            // åˆ‡æ›åˆ°ç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼æ™‚ï¼Œè®“å®šæ™‚å™¨è² è²¬æ›´æ–°é¡¯ç¤º
          }
        });
      }
    }
    
    // ç²å–ç•¶å‰æ¨¡æ“¬æ¨¡å¼
    function getSimMode() {
      try {
        const esp32Radio = document.querySelector('input[name="sim-mode"][value="esp32"]');
        const localRadio = document.querySelector('input[name="sim-mode"][value="local"]');
        
        // å¦‚æœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¿”å›é è¨­å€¼
        if (!esp32Radio || !localRadio) {
          console.warn('æ¨¡æ“¬æ¨¡å¼é¸æ“‡å™¨å…ƒç´ æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é è¨­ESP32æ¨¡å¼');
          return 'esp32';
        }
        
        const mode = esp32Radio.checked ? 'esp32' : 'local';
        return mode;
      } catch (e) {
        console.error('ç²å–æ¨¡æ“¬æ¨¡å¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
        return 'esp32'; // é è¨­å›åˆ°ESP32æ¨¡å¼
      }
    }

    // æ›´æ–°æ¨¡æ“¬æ¸¬è©¦é é¢æ¨™é¡Œå’Œèªªæ˜
    function updateSimulationPageTitle() {
      if (currentPage === 'simulation') {
        try {
          const currentSimMode = getSimMode();
          const subtitle = currentSimMode === 'local' ? 'å®Œæ•´è»Ÿé«”é‚è¼¯æ¸¬è©¦' : 'é›»æºæ¨¡æ“¬æ¸¬è©¦ï¼Œç¡¬é«”æ•¸æ“šé©—è­‰';
          
          const subtitleElement = document.getElementById('page-subtitle');
          if (subtitleElement) {
            subtitleElement.textContent = subtitle;
          }

          // æ ¹æ“šæ¨¡å¼é¡¯ç¤º/éš±è—åƒæ•¸æ¨¡æ“¬æ§åˆ¶æ¢
          const simControls = $('sim-controls');
          if (simControls) {
            if (currentSimMode === 'local') {
              simControls.style.display = 'block'; // ç´”æœ¬åœ°æ¨¡å¼é¡¯ç¤ºåƒæ•¸æ§åˆ¶æ¢
              pushBack('sim', 'ğŸ“Š ç´”æœ¬åœ°æ¨¡å¼ï¼šåƒæ•¸æ§åˆ¶å·²å•Ÿç”¨');
            } else {
              simControls.style.display = 'none';  // ESP32æ¨¡å¼éš±è—åƒæ•¸æ§åˆ¶æ¢ï¼ˆå› ç‚ºä½¿ç”¨çœŸå¯¦ç¡¬é«”æ•¸æ“šï¼‰
              pushBack('sim', 'ğŸ”— ESP32æ¨¡å¼ï¼šä½¿ç”¨çœŸå¯¦ç¡¬é«”æ•¸æ“šï¼Œåƒæ•¸æ§åˆ¶å·²éš±è—');
            }
          }

          // æ›´æ–°èªªæ˜å…§å®¹
          const descText = document.getElementById('sim-description-text');
          const descList = document.getElementById('sim-description-list');
          const descContainer = document.getElementById('sim-description');

          if (currentSimMode === 'local') {
            // ç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼èªªæ˜
            if (descText) {
              descText.textContent = 'å®Œæ•´è»Ÿé«”é‚è¼¯æ¸¬è©¦ï¼ŒåŒ…å«é›»æ± æ¨¡å‹ã€å±éšªé–€æª»ä¿è­·ã€è‡ªå‹•åˆ‡æ›ç­‰åŠŸèƒ½ï¼š';
            }
            if (descList) {
              descList.innerHTML = `
                <li>é›»æ± SOCæ¨¡æ“¬èˆ‡å±éšªé–€æª»ä¿è­·</li>
                <li>è‡ªå‹•åˆ‡æ›é‚è¼¯å’Œæ™‚æ®µæ§åˆ¶</li>
                <li>å……æ”¾é›»æ¼”ç®—æ³•èˆ‡å®‰å…¨æ©Ÿåˆ¶</li>
                <li>å¯é€éæ»‘æ¡¿èª¿æ•´SOCå’Œé›»æµåƒæ•¸</li>
              `;
            }
            if (descContainer) {
              descContainer.className = 'bg-purple-50 border border-purple-200 rounded-lg p-4';
            }
          } else {
            // ESP32æ¨¡å¼èªªæ˜
            if (descText) {
              descText.textContent = 'ç™¼é€é›»æºæ¨¡æ“¬ç‹€æ…‹åˆ°ESP32ï¼Œæ¥æ”¶çœŸå¯¦ç¡¬é«”æ•¸æ“šé€²è¡Œé©—è­‰ï¼š';
            }
            if (descList) {
              descList.innerHTML = `
                <li>æ¨¡æ“¬å¸‚é›»ä¸­æ–·èˆ‡æ¢å¾©ç‹€æ…‹</li>
                <li>ç™¼é€é›»æºåˆ‡æ›æŒ‡ä»¤åˆ°ESP32</li>
                <li>é¡¯ç¤ºESP32çœŸå¯¦é›»æ± æ¸¬é‡æ•¸æ“š</li>
                <li>ä¸ä½¿ç”¨åƒæ•¸æ¨¡æ“¬ï¼Œç¢ºä¿æ•¸æ“šçœŸå¯¦æ€§</li>
              `;
            }
            if (descContainer) {
              descContainer.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
            }
          }
        } catch (e) {
          console.error('æ›´æ–°æ¨¡æ“¬é é¢æ¨™é¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
          pushBack('error', `æ›´æ–°æ¨¡æ“¬é é¢æ¨™é¡Œå¤±æ•—ï¼š${e.message}`);
        }
      }
    }

    // ---- è¼ªè©¢èˆ‡æ¸²æŸ“ ----
    function applyCalib(d){ const o={...d}; if (d.v!=null) o.v=d.v*SETTINGS.calib.vGain+SETTINGS.calib.vOffset; if (Number.isFinite(d.i)) o.i=d.i*SETTINGS.calib.iGain+SETTINGS.calib.iOffset; return o; }
    async function fetchTelemetry(){
      if (SIM.enabled) {
        // æ¨¡æ“¬æ¨¡å¼ï¼šæ ¹æ“šé¸é …æ±ºå®šè¡Œç‚º
        const simMode = getSimMode();

        if (simMode === 'esp32') {
          // ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32æ¨¡å¼ï¼šåªæ¨¡æ“¬é›»æºç‹€æ…‹ï¼Œé¡¯ç¤ºESP32çœŸå¯¦ç¡¬é«”æ•¸æ“š
          try {
            // å…ˆç™¼é€é›»æºç‹€æ…‹æ¨¡æ“¬åˆ°ESP32
            await sendPowerSimulationState(); // ç­‰å¾…ç™¼é€å®Œæˆ

            // ç„¶å¾Œç²å–ESP32çš„çœŸå¯¦ç¡¬é«”æ•¸æ“š
            const res = await fetch(`${espIP}/telemetry`,{cache:'no-store'});
            if(!res.ok) throw new Error('http');
            const d = await res.json();

            // é©—è­‰æ”¶åˆ°çš„æ•¸æ“šæ˜¯æœ‰æ•ˆçš„
            if (d && (d.soc !== null || d.v !== null || d.i !== null)) {
              esp32Connected = true;
              renderTelemetry(applyCalib(d), false); // é¡¯ç¤ºESP32çš„çœŸå¯¦ç¡¬é«”æ•¸æ“š
              pushBack('sim', `å·²æ”¶åˆ°ESP32çœŸå¯¦æ•¸æ“šï¼šSOC=${d.soc}, V=${d.v}, I=${d.i}`);
            } else {
              throw new Error('ESP32æ•¸æ“šç„¡æ•ˆ');
            }
          } catch(e) {
            // ESP32é€£æ¥å¤±æ•—æˆ–æ•¸æ“šç„¡æ•ˆï¼Œé¡¯ç¤ºéŒ¯èª¤
            esp32Connected = false;
            renderTelemetry({soc:null, v:null, i:null, sensor_fault:true}, false);
            pushBack('sim', `ESP32é€£æ¥å¤±æ•—æˆ–æ•¸æ“šç„¡æ•ˆï¼š${e.message}`);
          }
        } else {
          // ç´”æœ¬åœ°æ¨¡æ“¬æ¨¡å¼ï¼šè¨­ç½®ESP32ç‚ºæœªé€£æ¥ç‹€æ…‹
          esp32Connected = false;
          return;
        }
      } else {
        // éæ¨¡æ“¬æ¨¡å¼ï¼šæ­£å¸¸ç²å–ESP32æ•¸æ“š
        try {
          const res = await fetch(`${espIP}/telemetry`,{cache:'no-store'});
          if(!res.ok) throw new Error('http');
          const d = await res.json();

          // é©—è­‰æ”¶åˆ°çš„æ•¸æ“šæ˜¯æœ‰æ•ˆçš„
          if (d && (d.soc !== null || d.v !== null || d.i !== null)) {
            esp32Connected = true;
            renderTelemetry(applyCalib(d), false);
          } else {
            throw new Error('ESP32æ•¸æ“šç„¡æ•ˆ');
          }
        } catch(e) {
          esp32Connected = false;
          renderTelemetry({soc:null, v:null, i:null, sensor_fault:true}, false);
        }
      }
    }
    function renderTelemetry(d, sim){
      // è¨˜éŒ„å¯¦æ©Ÿæ¨¡å¼çš„çœŸå¯¦SOCæ•¸æ“šï¼ˆç”¨æ–¼é›»æ± ä¿è­·é‚è¼¯ï¼‰
      if (!sim && d.soc !== null && Number.isFinite(d.soc)) {
        lastRealSOC = d.soc;
      }

      // ç³»çµ±ä»‹ç´¹é é¢ä¸éœ€è¦æ•¸æ“šæ›´æ–°ï¼Œè·³éæ§åˆ¶å°å…ƒç´ æ›´æ–°
      

       

       

      
             // æ›´æ–°å®æœºç›‘æ§é¡µé¢æ•°æ®ï¼ˆåªæ˜¾ç¤ºçœŸå®ESP32æ•°æ®ï¼Œä¸å—æ¨¡æ‹Ÿå½±å“ï¼‰
       try {
         if (!sim) {
           // ä½¿ç”¨å¹³æ»‘æ›´æ–°SOCé¡¯ç¤º
           smoothUpdateSOC($('live-soc'), d.soc);
           if ($('live-vbatt')) $('live-vbatt').textContent = (d.v!=null)?d.v.toFixed(2)+' V':'-- V';
           if ($('live-ibatt')) $('live-ibatt').textContent = (Number.isFinite(d.i))?d.i.toFixed(2)+' A':'-- A';
           if ($('live-sensor')) $('live-sensor').textContent = d.sensor_fault?'ç•°å¸¸':'æ­£å¸¸';
           if ($('live-last-update')) $('live-last-update').textContent = new Date().toLocaleTimeString();

           // æ›´æ–°SOCè¿›åº¦æ¡
           const liveSocBar = $('live-soc-bar');
           if (liveSocBar && d.soc != null) {
             const pct = Math.max(0, Math.min(100, d.soc));
             liveSocBar.style.width = pct + '%';
           }

           // æ›´æ–°ç”µæµçŠ¶æ€
           const currentStatus = $('live-current-status');
           if (currentStatus && Number.isFinite(d.i)) {
             if (d.i > 0.1) currentStatus.textContent = 'å……é›»ä¸­';
             else if (d.i < -0.1) currentStatus.textContent = 'æ”¾é›»ä¸­';
             else currentStatus.textContent = 'å¾…æ©Ÿä¸­';
           }

           // æ›´æ–°è¿æ¥çŠ¶æ€ï¼ˆæ ¹æ“šå¯¦éš›ESP32é€£æ¥ç‹€æ…‹ï¼‰
           if (esp32Connected) {
             if ($('live-connection-indicator')) $('live-connection-indicator').className = 'w-3 h-3 rounded-full bg-green-500';
             if ($('live-connection-text')) $('live-connection-text').textContent = 'å·²é€£æ¥';
           } else {
             if ($('live-connection-indicator')) $('live-connection-indicator').className = 'w-3 h-3 rounded-full bg-gray-400';
             if ($('live-connection-text')) $('live-connection-text').textContent = 'æœªé€£æ¥';
           }
         } else {
           // æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ï¼Œå®æœºç›‘æ§é¡µé¢æ˜¾ç¤ºESP32è¿æ¥çŠ¶æ€ï¼ˆä½†æ•°æ®æ¥è‡ªæ¨¡æ‹Ÿï¼‰
           smoothUpdateSOC($('live-soc'), null);
           if ($('live-vbatt')) $('live-vbatt').textContent = '-- V';
           if ($('live-ibatt')) $('live-ibatt').textContent = '-- A';
           if ($('live-sensor')) $('live-sensor').textContent = 'æ¨¡æ“¬ä¸­';
           if ($('live-last-update')) $('live-last-update').textContent = '--';

           // é‡ç½®è¿›åº¦æ¡å’ŒçŠ¶æ€
           if ($('live-soc-bar')) $('live-soc-bar').style.width = '0%';
           if ($('live-current-status')) $('live-current-status').textContent = 'å¾…æ©Ÿä¸­';
           // æ›´æ–°ESP32è¿æ¥çŠ¶æ€
           if (esp32Connected) {
             if ($('live-connection-indicator')) $('live-connection-indicator').className = 'w-3 h-3 rounded-full bg-green-500';
             if ($('live-connection-text')) $('live-connection-text').textContent = 'å·²é€£æ¥';
           } else {
             if ($('live-connection-indicator')) $('live-connection-indicator').className = 'w-3 h-3 rounded-full bg-gray-400';
             if ($('live-connection-text')) $('live-connection-text').textContent = 'æœªé€£æ¥';
           }
         }
       } catch(e) {
         pushBack('error', `å¯¦æ©Ÿç›£æ§é é¢æ›´æ–°éŒ¯èª¤ï¼š${e.message}`);
       }

       // æ›´æ–°æ¨¡æ“¬æ¸¬è©¦é é¢æ•¸æ“š
       try {
         if (SIM.enabled) {
           // æ¨¡æ“¬æ¨¡å¼é–‹å•Ÿæ™‚æ‰æ›´æ–°æ¨¡æ“¬æ¸¬è©¦é é¢
           const currentSimMode = getSimMode();

           // é¡¯ç¤ºæ•¸æ“šï¼ˆæ ¹æ“šæ¨¡å¼æ±ºå®šæ•¸æ“šä¾†æºï¼‰
           smoothUpdateSOC($('sim-soc-display'), d.soc);
           if ($('sim-vbatt-display')) $('sim-vbatt-display').textContent = (d.v!=null)?d.v.toFixed(2)+' V':'-- V';
           if ($('sim-ibatt-display')) $('sim-ibatt-display').textContent = (Number.isFinite(d.i))?d.i.toFixed(2)+' A':'-- A';

           // æ ¹æ“šæ¨¡å¼è¨­ç½®æ„Ÿæ¸¬å™¨ç‹€æ…‹
           if ($('sim-sensor-display')) {
             if (currentSimMode === 'local') {
               $('sim-sensor-display').textContent = 'ç´”æœ¬åœ°æ¨¡æ“¬';
             } else {
               $('sim-sensor-display').textContent = esp32Connected ? 'ESP32çœŸå¯¦æ•¸æ“š' : 'ESP32é€£æ¥å¤±æ•—';
             }
           }



           // æ›´æ–°SOCè¿›åº¦æ¡
           const simSocBar = $('sim-soc-bar');
           if (simSocBar && d.soc != null) {
             const pct = Math.max(0, Math.min(100, d.soc));
             simSocBar.style.width = pct + '%';
           }

           // æ›´æ–°ç”µæµçŠ¶æ€
           const simCurrentStatus = $('sim-current-status');
           if (simCurrentStatus && Number.isFinite(d.i)) {
             if (d.i > 0.1) simCurrentStatus.textContent = 'å……é›»ä¸­';
             else if (d.i < -0.1) simCurrentStatus.textContent = 'æ”¾é›»ä¸­';
             else simCurrentStatus.textContent = 'å¾…æ©Ÿä¸­';
           }
         } else {
           // éæ¨¡æ‹Ÿæ¨¡å¼ä¸‹ï¼Œæ¨¡æ‹Ÿæµ‹è¯•é¡µé¢æ˜¾ç¤ºæœªæ¨¡æ‹Ÿ
           smoothUpdateSOC($('sim-soc-display'), null);
           if ($('sim-vbatt-display')) $('sim-vbatt-display').textContent = '-- V';
           if ($('sim-ibatt-display')) $('sim-ibatt-display').textContent = '-- A';
           if ($('sim-sensor-display')) $('sim-sensor-display').textContent = 'æœªæ¨¡æ“¬';

           // é‡ç½®è¿›åº¦æ¡å’ŒçŠ¶æ€
           if ($('sim-soc-bar')) $('sim-soc-bar').style.width = '0%';
           if ($('sim-current-status')) $('sim-current-status').textContent = 'å¾…æ©Ÿä¸­';
         }
       } catch(e) {
         pushBack('error', `æ¨¡æ“¬æ¸¬è©¦é é¢æ›´æ–°éŒ¯èª¤ï¼š${e.message}`);
       }

      // æ›´æ–°è½®è¯¢çŠ¶æ€
      if (typeof d.soc==='number' && d.soc <= SETTINGS.sim.socThreshold+5) boostUntil = Date.now()+SETTINGS.net.boostHoldMs;
    }
    async function pollTelemetry(){ await fetchTelemetry(); const fast=Date.now()<boostUntil; setTimeout(pollTelemetry, fast?SETTINGS.net.pollFastMs:SETTINGS.net.pollBaseMs); }

    // ---- è¨­å®š/é¢æ¿ ----
    function connectESP(){
      const ipInputElement = $('cfg-ip');
      if (!ipInputElement) {
        updateConnectionStatus('è¼¸å…¥å…ƒç´ æœªæ‰¾åˆ°', 'error');
        pushBack('error', 'ESP32ä½å€è¼¸å…¥å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      const newIP = ipInputElement.value.trim();
      if (!newIP) {
        updateConnectionStatus('è«‹è¼¸å…¥ESP32ä½å€', 'error');
        return;
      }

      // é©—è­‰åœ°å€æ ¼å¼
      if (!newIP.startsWith('http://') && !newIP.startsWith('https://')) {
        updateConnectionStatus('åœ°å€æ ¼å¼éŒ¯èª¤ï¼Œéœ€è¦åŒ…å« http://', 'error');
        return;
      }

      // é©—è­‰URLæ ¼å¼
      try {
        new URL(newIP);
      } catch (e) {
        updateConnectionStatus('ç„¡æ•ˆçš„URLæ ¼å¼', 'error');
        return;
      }

      espIP = newIP;
      SETTINGS.net.espIP = espIP;
      saveSettings();
      updateConnectionStatus('æ­£åœ¨é€£æ¥...', 'connecting');

      // ç«‹å³å˜—è©¦é€£æ¥
      fetchTelemetry().then(() => {
        updateConnectionStatus('é€£æ¥æˆåŠŸ', 'success');
        pushBack('system', `âœ… å·²é€£æ¥åˆ°ESP32: ${espIP}`);
        pushBack('system', 'ğŸ”„ å¯¦æ©Ÿæ¨¡å¼å’ŒESP32æ¨¡æ“¬æ¨¡å¼ç¾å·²å¯ç”¨');

        // å¦‚æœç•¶å‰åœ¨æ¨¡æ“¬æ¨¡å¼ä¸”é¸æ“‡ESP32æ¨¡å¼ï¼Œç«‹å³ç™¼é€ç‹€æ…‹
        if (SIM.enabled && getSimMode() === 'esp32') {
          sendPowerSimulationState();
          pushBack('system', 'ğŸ“¤ å·²ç™¼é€æ¨¡æ“¬ç‹€æ…‹åˆ°ESP32');
        }
      }).catch((error) => {
        updateConnectionStatus('é€£æ¥å¤±æ•—', 'error');
        pushBack('error', `âŒ ç„¡æ³•é€£æ¥åˆ°ESP32: ${espIP}`);
        pushBack('error', `éŒ¯èª¤è©³æƒ…: ${error.message}`);
      });
    }

    async function testConnection(){
      if (!espIP) {
        updateConnectionStatus('è«‹å…ˆè¨­å®šESP32ä½å€', 'error');
        return;
      }

      updateConnectionStatus('æ¸¬è©¦ä¸­...', 'connecting');
      try {
        const t0 = performance.now();
        const response = await fetch(`${espIP}/telemetry`, {cache: 'no-store'});
        const t1 = performance.now();

        if (response.ok) {
          const ping = Math.round(t1 - t0);
          updateConnectionStatus(`é€£æ¥æ­£å¸¸ (${ping}ms)`, 'success');
          pushBack('system', `ESP32é€£æ¥æ¸¬è©¦æˆåŠŸï¼Œå»¶é²: ${ping}ms`);
        } else {
          updateConnectionStatus('é€£æ¥ç•°å¸¸', 'error');
          pushBack('error', `ESP32å›æ‡‰ç•°å¸¸: ${response.status}`);
        }
      } catch (error) {
        updateConnectionStatus('é€£æ¥å¤±æ•—', 'error');
        pushBack('error', `ESP32é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
      }
    }

    function initializeSettings() {
      // è¨­å®šESP32åœ°å€è¼¸å…¥æ¡†çš„å€¼
      if ($('cfg-ip')) {
        $('cfg-ip').value = espIP || '';
      }

      // æ›´æ–°é€£æ¥ç‹€æ…‹
      if (esp32Connected) {
        updateConnectionStatus(`å·²é€£æ¥åˆ° ${espIP}`, 'success');
      } else if (espIP) {
        updateConnectionStatus(`æœªé€£æ¥ (${espIP})`, 'error');
      } else {
        updateConnectionStatus('å°šæœªè¨­å®šESP32ä½å€', 'default');
      }
    }

    function updateConnectionStatus(message, type) {
      const statusEl = $('connection-status');
      if (!statusEl) return;

      statusEl.textContent = message;
      statusEl.className = 'text-sm text-center py-2 rounded-lg ';

      switch (type) {
        case 'success':
          statusEl.className += 'bg-green-100 text-green-800';
          break;
        case 'error':
          statusEl.className += 'bg-red-100 text-red-800';
          break;
        case 'connecting':
          statusEl.className += 'bg-yellow-100 text-yellow-800';
          break;
        default:
          statusEl.className += 'bg-gray-100 text-gray-600';
      }
    }

    // é¡µé¢åˆ‡æ¢åŠŸèƒ½
    function switchPage(pageId) {
      // å…ˆæ·¡å‡ºç•¶å‰é é¢
      const currentActivePage = document.querySelector('.page.active');
      if (currentActivePage) {
        currentActivePage.style.opacity = '0';
        currentActivePage.style.transform = 'translateY(-10px)';
      }

      // å»¶é²å¾Œåˆ‡æ›é é¢
      setTimeout(() => {
        // éšè—æ‰€æœ‰é¡µé¢
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
          page.style.opacity = '0';
          page.style.transform = 'translateY(20px)';
        });

        // ç§»é™¤æ‰€æœ‰ä¾§è¾¹æ æ´»åŠ¨çŠ¶æ€
        document.querySelectorAll('.sidebar-item').forEach(item => {
          item.classList.remove('active');
        });

        // æ˜¾ç¤ºç›®æ ‡é¡µé¢
        const targetPage = document.getElementById(pageId);
        targetPage.classList.add('active');

        // è®¾ç½®ä¾§è¾¹æ æ´»åŠ¨çŠ¶æ€
        const menuItems = document.querySelectorAll('.sidebar-item');
        const pageMap = {
          'dashboard': 0,
          'live': 1,
          'simulation': 2,
          'settings': 3,
          'logs': 4
        };
        if (pageMap[pageId] !== undefined) {
          menuItems[pageMap[pageId]].classList.add('active');
        }

        // æ·¡å…¥æ–°é é¢
        setTimeout(() => {
          targetPage.style.opacity = '1';
          targetPage.style.transform = 'translateY(0)';
        }, 50);

        currentPage = pageId;
      }, 150);
      
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      const titles = {
        'dashboard': 'ç³»çµ±ä»‹ç´¹',
        'live': 'å¯¦æ©Ÿç›£æ§',
        'simulation': 'æ¨¡æ“¬æ¸¬è©¦',
        'settings': 'ç³»çµ±è¨­å®š',
        'logs': 'äº‹ä»¶æ—¥èªŒ'
      };

      // å‹•æ…‹ç”Ÿæˆæ¨¡æ“¬æ¸¬è©¦é é¢çš„å‰¯æ¨™é¡Œ
      let simulationSubtitle = 'é›»æºæ¨¡æ“¬æ¸¬è©¦ï¼Œç¡¬é«”æ•¸æ“šé©—è­‰';
      if (pageId === 'simulation') {
        try {
          const currentSimMode = getSimMode();
          if (currentSimMode === 'local') {
            simulationSubtitle = 'å®Œæ•´è»Ÿé«”é‚è¼¯æ¸¬è©¦';
          } else {
            simulationSubtitle = 'é›»æºæ¨¡æ“¬æ¸¬è©¦ï¼Œç¡¬é«”æ•¸æ“šé©—è­‰';
          }
        } catch (e) {
          console.warn('ç²å–æ¨¡æ“¬æ¨¡å¼å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', e);
          simulationSubtitle = 'é›»æºæ¨¡æ“¬æ¸¬è©¦ï¼Œç¡¬é«”æ•¸æ“šé©—è­‰';
        }
      }

      const subtitles = {
        'dashboard': 'æ™ºèƒ½å¾®é›»ç¶²æ§åˆ¶ç³»çµ±',
        'live': 'å¯¦æ©Ÿé€£æ¥èˆ‡æ§åˆ¶',
        'simulation': simulationSubtitle,
        'settings': 'ESP32é€£æ¥è¨­å®š',
        'logs': 'ç³»çµ±äº‹ä»¶è¨˜éŒ„'
      };

      const titleElement = document.getElementById('page-title');
      const subtitleElement = document.getElementById('page-subtitle');
      
      if (titleElement) titleElement.textContent = titles[pageId] || 'ç³»çµ±ä»‹ç´¹';
      if (subtitleElement) subtitleElement.textContent = subtitles[pageId] || 'æ™ºèƒ½å¾®é›»ç¶²æ§åˆ¶ç³»çµ±';

      // å¦‚æœåˆ‡æ›åˆ°æ¨¡æ“¬æ¸¬è©¦é é¢ï¼Œæ›´æ–°èªªæ˜å…§å®¹
      if (pageId === 'simulation') {
        updateSimulationPageTitle();
      }

      // å¦‚æœåˆ‡æ›åˆ°è¨­å®šé é¢ï¼Œåˆå§‹åŒ–è¨­å®šå€¼
      if (pageId === 'settings') {
        initializeSettings();
        // é–‹å§‹å®šæœŸæ›´æ–°é€£æ¥ç‹€æ…‹
        if (window.settingsStatusInterval) {
          clearInterval(window.settingsStatusInterval);
        }
        window.settingsStatusInterval = setInterval(() => {
          if (currentPage === 'settings') {
            initializeSettings(); // æ›´æ–°é€£æ¥ç‹€æ…‹
          } else {
            clearInterval(window.settingsStatusInterval);
            window.settingsStatusInterval = null;
          }
        }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
      }

      // æ›´æ–°æ™‚é–“é¡¯ç¤ºï¼ˆåˆ‡æ›é é¢æ™‚ç«‹å³æ›´æ–°ï¼‰
      updateTime();
    }

    // æ—¶é—´æ›´æ–°
    function updateTime() {
      const timeElement = $('current-time');
      const statusElement = $('time-status');

      if (timeElement && statusElement) {
        if (mockNow) {
          // æ¨¡æ“¬æ™‚é–“æ¨¡å¼
          const timeStr = mockNow.toLocaleTimeString();
          timeElement.textContent = timeStr;
          timeElement.className = 'text-sm text-purple-600 font-semibold';
          statusElement.textContent = 'æ¨¡æ“¬';
          statusElement.className = 'text-xs px-2 py-1 rounded-full bg-purple-600 text-white font-bold';
          statusElement.classList.remove('hidden');
        } else {
          // çœŸå¯¦æ™‚é–“æ¨¡å¼
          const now = new Date();
          timeElement.textContent = now.toLocaleTimeString();
          timeElement.className = 'text-sm text-gray-800 font-semibold';
          statusElement.textContent = 'çœŸå¯¦';
          statusElement.className = 'text-xs px-2 py-1 rounded-full bg-gray-700 text-white font-bold';

          // åªåœ¨æ¨¡æ“¬æ¸¬è©¦é é¢é¡¯ç¤ºæ™‚é–“ç‹€æ…‹æ¨™ç±¤
          if (currentPage === 'simulation') {
            statusElement.classList.remove('hidden');
          } else {
            statusElement.classList.add('hidden');
          }
        }
      }
    }
    setInterval(updateTime, 1000);
    updateTime();

    // æ›´æ–°ESP32é€£æ¥ç‹€æ…‹é¡¯ç¤º
    function updateESPConnectionStatus() {
      const statusElement = $('esp-connection-status');
      if (statusElement) {
        if (esp32Connected) {
          statusElement.textContent = 'å·²é€£æ¥';
          statusElement.className = 'font-semibold text-green-600';
        } else {
          statusElement.textContent = 'æœªé€£æ¥';
          statusElement.className = 'font-semibold text-red-600';
        }
      }
    }

    // åˆå§‹åŒ–
    (function init(){
      try {
        pushBack('system', 'ğŸš€ å¾®é›»ç¶²æ§åˆ¶ç³»çµ±å•Ÿå‹•ä¸­...');

        loadSettings();
        pushBack('system', `ğŸ“‹ å·²è¼‰å…¥è¨­å®š - ESP32: ${espIP || 'æœªè¨­å®š'}`);
        pushBack('system', 'ğŸ”’ å¯¦æ©Ÿæ¨¡å¼é›»æ± ä¿è­·å·²å•Ÿç”¨ - èˆ‡æ¨¡æ“¬æ¨¡å¼ä½¿ç”¨ç›¸åŒçš„å®‰å…¨é‚è¼¯');
        pushBack('system', `âš ï¸ å±éšªé–€æª»è¨­å®šï¼šSOC â‰¤ ${SETTINGS.sim.critThreshold}% æ™‚å°‡å¼·åˆ¶å¸‚é›»å……é›»`);
        pushBack('system', `ğŸ”‹ å……é›»å®Œæˆé–€æª»ï¼šSOC â‰¥ ${SETTINGS.sim.stopSoc}% æ™‚å°‡è§£é™¤ä¿è­·æ¨¡å¼`);

        updateDisplay();
        updateSimDisplay(); // åˆå§‹åŒ–æ¨¡æ“¬é¡¯ç¤ºï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
        
        // å®‰å…¨åœ°é™„åŠ äº‹ä»¶è™•ç†å™¨
        try {
          attachSocHandlers();
          attachIHandlers();
          attachSimModeHandlers(); // æ·»åŠ æ¨¡æ“¬æ¨¡å¼é¸é …äº‹ä»¶è™•ç†å™¨
        } catch (e) {
          console.warn('éƒ¨åˆ†äº‹ä»¶è™•ç†å™¨é™„åŠ å¤±æ•—:', e);
          pushBack('warning', 'éƒ¨åˆ†æ§åˆ¶åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
        }
        
        updateSimLabels(); // åˆå§‹åŒ–æ¨¡æ“¬æ¨™ç±¤ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
        updateSimulationPageTitle(); // åˆå§‹åŒ–æ¨¡æ“¬é é¢æ¨™é¡Œå’Œèªªæ˜

        pushBack('system', 'ğŸ”„ é–‹å§‹æ•¸æ“šè¼ªè©¢...');
        pollTelemetry();

        pushBack('system', 'âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å·²å°±ç·’');
        pushBack('system', 'ğŸ“Š å¯¦æ©Ÿæ¨¡å¼èˆ‡æ¨¡æ“¬æ¨¡å¼ç¾åœ¨å…·æœ‰ç›¸åŒçš„é›»æ± å®‰å…¨ä¿è­·æ©Ÿåˆ¶');
        setMainMsg('ç³»çµ±å°±ç·’');
      } catch (e) {
        console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', e);
        pushBack('error', `ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š${e.message}`);
        setMainMsg('ç³»çµ±åˆå§‹åŒ–å¤±æ•—', true);
      }
    })();
  </script>
</body>
</html>
